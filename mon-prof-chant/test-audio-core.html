<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Test Audio Core ‚Äî Pitch (cents/notes) + Timeline (ligne m√©diane)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220;--panel:#0e1729;--card:#111a2e;--grid:#1a2642;--text:#e5e7eb;--muted:#9ca3af;
      --ok:#10b981;--warn:#f59e0b;--err:#ef4444;--accent:#60a5fa;--accent2:#34d399;--axis:#334155;
      --orange:#f59e0b;--blue:#3b82f6;--green:#22c55e;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
    .h1{font-weight:800;font-size:20px;margin:8px 0 16px}
    .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #1f2a44;background:var(--card);
      color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .btn.ok{background:#0e1f14;border-color:#173621;color:#c8facc}
    .btn.warn{background:#241a08;border-color:#4b320a;color:#ffe4b5}
    .btn.stop{background:#2a0f14;border-color:#4a171f;color:#fecaca}
    .seg{display:inline-flex;border:1px solid #22304f;background:var(--card);border-radius:12px;overflow:hidden}
    .seg button{padding:8px 12px;border:0;background:transparent;color:var(--text);cursor:pointer}
    .seg button.active{background:#16213a}
    .timer{padding:8px 10px;border:1px solid #22304f;border-radius:10px;background:var(--card);min-width:54px;text-align:center}
    .modes{display:flex;gap:8px;margin:6px 0 10px}
    .mode{border:1px solid #22304f;background:#0f172a;color:#cbd5e1;padding:6px 10px;border-radius:10px;cursor:pointer}
    .mode.active{background:#16213a;color:#fff}
    .noteBox{display:inline-flex;gap:6px;align-items:center;margin-left:10px;color:#cbd5e1}
    .canvasWrap{background:var(--panel);border:1px solid #1f2a44;border-radius:12px;padding:12px}
    .hint{color:var(--muted);font-size:12px;margin:6px 0 12px}
    .legend{display:flex;gap:18px;flex-wrap:wrap;color:#cbd5e1;font-size:12px;margin-top:8px}
    .dot{display:inline-block;width:10px;height:10px;border-radius:2px;margin-right:6px;vertical-align:-1px}
    .d1{background:var(--blue)} .d2{background:#22c55e} .d3{background:var(--orange)}
    .footerBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .log{background:#0b1020;border:1px solid #1f2a44;border-radius:12px;padding:10px;color:#dbeafe;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;max-height:210px;overflow:auto}
    .badge{display:inline-flex;gap:6px;align-items:center;border:1px solid #22304f;background:#0b1220;padding:4px 8px;border-radius:8px}
    .b-ok{color:#bbf7d0;border-color:#206a44;background:#052216}
    .b-warn{color:#fde68a;border-color:#6b4d11;background:#261a06}
    .right{margin-left:auto}
    canvas{display:block;width:100%;height:420px;background:#0b1324;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="h1">üéöÔ∏è Test Audio Core ‚Äî Pitch (cents/notes) + Timeline (ligne m√©diane)</div>

    <!-- Barre d‚Äôactions -->
    <div class="bar">
      <button id="btnMic" class="btn">Activer micro</button>

      <span class="seg" id="segMonitor">
        <button data-val="off" class="active">Moniteur live</button>
        <button data-val="on">ON</button>
      </span>

      <div class="seg" id="segRecord">
        <button id="btnStart">‚ñ∂Ô∏é D√©marrer l‚Äôenregistrement</button>
        <button id="btnStop" class="stop">‚ñ† Stop</button>
      </div>

      <div class="timer" id="timer">00:00</div>

      <div class="right seg" id="segZoom">
        <button data-z="1" class="active">x1</button>
        <button data-z="2">x2</button>
        <button data-z="4">x4</button>
      </div>
    </div>

    <!-- Modes d‚Äôaffichage -->
    <div class="modes">
      <div class="mode active" data-mode="cents">Cents (justesse)</div>
      <div class="mode" data-mode="notes">Absolu (notes)</div>
      <span class="noteBox">
        <span id="currentNote">‚Äî</span>
        <span id="offsetCents" title="√©cart en cents par rapport √† la note m√©diane">(+0 c)</span>
      </span>
    </div>

    <!-- Zone graphique -->
    <div class="canvasWrap">
      <div class="hint">Astuce : la courbe n‚Äôappara√Æt qu‚Äôen <b>Moniteur live ON</b> ou pendant un <b>enregistrement</b>. La ligne verte = m√©diane (0 cent / note de r√©f√©rence). Le curseur orange (temps) ne bouge que pendant un enregistrement.</div>
      <canvas id="scope" width="1200" height="420"></canvas>

      <div class="legend">
        <span><span class="dot d1"></span>Courbe de pitch (continu)</span>
        <span><span class="dot d2"></span>Ligne m√©diane (0 cent / note de r√©f√©rence)</span>
        <span><span class="dot d3"></span>Curseur temps (enregistrement)</span>
        <span id="pitchyStatus" class="badge b-warn">Pitchy (d√©tection) : <b>non charg√©</b></span>
        <span id="mp3Status" class="badge b-warn">MP3 : <b>encodeur absent</b></span>
      </div>

      <div class="footerBtns">
        <button id="btnWebM" class="btn">‚¨áÔ∏è T√©l√©charger WebM</button>
        <button id="btnWAV" class="btn">üéß Exporter en WAV</button>
        <button id="btnMP3" class="btn" disabled title="Ajoute /src/vendor/lame.min.js pour activer">üéµ Exporter en MP3</button>
      </div>
    </div>

    <div class="h1" style="margin-top:18px">Console</div>
    <pre id="log" class="log">Syst√®me de logs pr√™t‚Ä¶</pre>
  </div>

  <!-- Lib locale : algorithme YIN (compact) -->
  <script src="./src/vendor/pitchy-lite.js"></script>
  <!-- Exports locaux -->
  <script src="./src/utils/wav-export.js"></script>
  <script src="./src/utils/mp3-export.js"></script>

  <script>
  /***************  Petit logger ***************/
  const logBox = document.getElementById('log');
  const log = (lvl, msg) => {
    const now = new Date();
    const h = now.getHours().toString().padStart(2,'0');
    const m = now.getMinutes().toString().padStart(2,'0');
    logBox.textContent += `\n[${h}:${m}] [${lvl}] ${msg}`;
    logBox.scrollTop = logBox.scrollHeight;
  };

  /***************  R√©fs UI ***************/
  const btnMic   = document.getElementById('btnMic');
  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');
  const timerEl  = document.getElementById('timer');
  const scope    = document.getElementById('scope');
  const ctx      = scope.getContext('2d');
  const pitchyStatus = document.getElementById('pitchyStatus');
  const mp3Status    = document.getElementById('mp3Status');
  const btnWebM = document.getElementById('btnWebM');
  const btnWAV  = document.getElementById('btnWAV');
  const btnMP3  = document.getElementById('btnMP3');
  const segMonitor = document.getElementById('segMonitor');
  const segZoom    = document.getElementById('segZoom');
  const modeBtns   = document.querySelectorAll('.mode');
  const currentNoteEl = document.getElementById('currentNote');
  const offsetEl      = document.getElementById('offsetCents');

  /***************  √âtat ***************/
  let audioCtx = null;
  let micStream = null;
  let analyser = null;
  let processor = null;
  let mediaRecorder = null;
  let chunks = [];
  let lastBlob = null;
  let ticking = false;
  let monitorLive = false;
  let zoomY = 1;  // 1 / 2 / 4
  let mode = 'cents'; // 'cents' | 'notes'
  let medianNoteHz = 440 * Math.pow(2, (9 - 9)); // placeholder
  let recStart = 0;
  let rafId = 0;

  // Pitch lib dispo ?
  const hasPitchy = !!window.PitchyLite;
  if (hasPitchy) {
    pitchyStatus.innerHTML = 'Pitchy (d√©tection) : <b class="b-ok">charg√©</b>';
    pitchyStatus.className = 'badge b-ok';
  } else {
    log('WARN','Pitchy non charg√© (lib locale manquante) ‚Üí pas de courbe.');
  }

  // Encodeur MP3 dispo ?
  const hasLame = !!window.MP3Export && window.MP3Export.isReady();
  if (hasLame) {
    mp3Status.innerHTML = 'MP3 : <b class="b-ok">encodeur pr√™t</b>';
    mp3Status.className = 'badge b-ok';
    btnMP3.disabled = false;
  }

  /***************  Canvas helpers ***************/
  function clearCanvas() {
    ctx.fillStyle = '#0b1324';
    ctx.fillRect(0,0,scope.width,scope.height);
    // grille horizontale + √©tiquettes
    const midY = scope.height/2;
    const maxCents = 300/zoomY; // -300..+300 centr√©s
    const step = 100/zoomY;     // graduations
    ctx.strokeStyle = '#142039';
    ctx.lineWidth = 1;
    ctx.beginPath();
    for (let c=-maxCents; c<=maxCents; c+=step) {
      const y = mapCentsToY(c);
      ctx.moveTo(0, y); ctx.lineTo(scope.width, y);
    }
    ctx.stroke();

    // m√©diane (0 cent)
    ctx.strokeStyle = '#22c55e';
    ctx.beginPath();
    ctx.moveTo(0, midY); ctx.lineTo(scope.width, midY);
    ctx.stroke();

    // labels ‚ÄúTr√®s grave / Grave / Aigu / Tr√®s aigu‚Äù
    ctx.fillStyle = '#9ca3af';
    ctx.font = '12px system-ui';
    ctx.fillText('Tr√®s grave', scope.width-80, mapCentsToY(+250/zoomY));
    ctx.fillText('Grave',      scope.width-80, mapCentsToY(+50/zoomY));
    ctx.fillText('Aigu',       scope.width-80, mapCentsToY(-50/zoomY));
    ctx.fillText('Tr√®s aigu',  scope.width-80, mapCentsToY(-250/zoomY));
  }
  function mapCentsToY(c){
    const max = 300; // plage totale visuelle
    const norm = c / 300;
    return scope.height/2 - norm*scope.height/2;
  }

  function drawCursorTime() {
    if (!recStart) return;
    const elapsed = (audioCtx.currentTime - recStart);
    const ratio = Math.min(elapsed / 120, 1); // 120s √©chelle temporelle fixe de la d√©mo
    const x = 40 + (scope.width-60) * ratio;
    ctx.strokeStyle = '#f59e0b';
    ctx.beginPath();
    ctx.moveTo(x, 10); ctx.lineTo(x, scope.height-10);
    ctx.stroke();
  }

  /***************  Audio ***************/
  async function ensureAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)({sampleRate: 48000, latencyHint:'interactive'});
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    processor = audioCtx.createScriptProcessor(2048, 1, 1);
    log('INFO','AudioEngine pr√™t');
  }

  async function activateMic() {
    await ensureAudio();
    micStream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
    const src = audioCtx.createMediaStreamSource(micStream);
    src.connect(analyser);
    processor.connect(audioCtx.destination);
    log('INFO','Micro activ√©');
  }

  function startMonitor() {
    if (!hasPitchy || !analyser) return;
    if (ticking) return;
    ticking = true;
    const buf = new Float32Array(analyser.fftSize);
    const det = new PitchyLite(audioCtx.sampleRate);

    const tick = () => {
      if (!ticking) return;
      clearCanvas();

      if (monitorLive || mediaRecorder?.state === 'recording') {
        analyser.getFloatTimeDomainData(buf);
        const hz = det.detect(buf); // null si rien
        if (hz) {
          // convertir en cents vs note m√©diane (premi√®re note stable apr√®s rec start)
          const cents = hzToCents(hz, medianNoteHz);
          drawPitchPoint(cents);
          if (mode === 'notes') {
            currentNoteEl.textContent = hzToNoteName(hz);
            offsetEl.textContent = ''; // pas d‚Äôoffset en mode notes
          } else {
            currentNoteEl.textContent = hzToNoteName(medianNoteHz);
            offsetEl.textContent = `(${Math.round(cents)} c)`;
          }
        }
        drawCursorTime();
      } else {
        clearCanvas();
      }
      rafId = requestAnimationFrame(tick);
    };
    tick();
  }
  function stopMonitor() { ticking = false; cancelAnimationFrame(rafId); clearCanvas(); }

  function drawPitchPoint(cents) {
    // On trace un point (pas une barre), qui se d√©place vers la droite avec le temps.
    const t = recStart ? (audioCtx.currentTime - recStart) : 0; // s
    const maxTime = 120; // 2 min d‚Äô√©chelle
    const leftPad = 40, rightPad = 20;
    const x = leftPad + (scope.width - leftPad - rightPad) * Math.min(t / maxTime, 1);
    const y = mapCentsToY(cents/zoomY);

    ctx.fillStyle = '#3b82f6';
    ctx.beginPath();
    ctx.arc(x, y, 2.5, 0, Math.PI*2);
    ctx.fill();
  }

  /***************  Pitch helpers ***************/
  function hzToNoteNumber(hz){ return 69 + 12 * Math.log2(hz/440); }
  function hzToNoteName(hz){
    const n = Math.round(hzToNoteNumber(hz));
    const names = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const name = names[(n+1200)%12];
    const oct = Math.floor(n/12) - 1;
    return `${name}${oct}`;
  }
  function centsBetween(freq1, freq2){ return 1200 * Math.log2(freq1/freq2); }
  function hzToCents(hz, refHz){ return centsBetween(hz, refHz); }

  /***************  Recorder ***************/
  function startRecording() {
    if (!micStream) { log('WARN','Active d‚Äôabord le micro.'); return; }
    if (!MediaRecorder) { log('ERROR','MediaRecorder non support√©.'); return; }
    chunks = []; lastBlob = null;
    mediaRecorder = new MediaRecorder(micStream, {mimeType: 'audio/webm;codecs=opus'});
    mediaRecorder.ondataavailable = e => { if (e.data && e.data.size>0) chunks.push(e.data); };
    mediaRecorder.onstop = () => {
      if (chunks.length) {
        lastBlob = new Blob(chunks, {type: 'audio/webm'});
        log('INFO','Enregistrement termin√©.');
      } else {
        lastBlob = null;
        log('WARN','Aucun chunk captur√©. (Permissions/restrictions ?)');
      }
      recStart = 0;
      updateTimer(0);
      drawCursorTime();
    };
    mediaRecorder.start(100);
    recStart = audioCtx.currentTime;
    log('INFO','Enregistrement en cours‚Ä¶');
    tickTimer();
  }
  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
    }
  }

  /***************  Timer ***************/
  let timerInt = null;
  function updateTimer(s){
    const mm = Math.floor(s/60).toString().padStart(2,'0');
    const ss = Math.floor(s%60).toString().padStart(2,'0');
    timerEl.textContent = `${mm}:${ss}`;
  }
  function tickTimer(){
    clearInterval(timerInt);
    timerInt = setInterval(()=>{
      if (!recStart) return;
      updateTimer(audioCtx.currentTime - recStart);
    }, 250);
  }

  /***************  Actions UI ***************/
  // Micro
  btnMic.addEventListener('click', async ()=>{
    try {
      await activateMic();
      btnMic.classList.add('ok');
      if (monitorLive) startMonitor(); else { clearCanvas(); }
    } catch(e){ log('ERROR', 'Micro : '+(e.message||e)); }
  });

  // Moniteur ON/OFF
  segMonitor.addEventListener('click', e=>{
    if (e.target.tagName!=='BUTTON') return;
    const val = e.target.dataset.val;
    segMonitor.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b===e.target));
    monitorLive = (val==='on');
    log('INFO', `Moniteur live ${monitorLive?'ON':'OFF'}`);
    if (monitorLive) startMonitor(); else stopMonitor();
  });

  // Zoom vertical
  segZoom.addEventListener('click', e=>{
    if (e.target.tagName!=='BUTTON') return;
    zoomY = Number(e.target.dataset.z||'1');
    segZoom.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b===e.target));
    clearCanvas();
  });

  // Mode d‚Äôaffichage
  modeBtns.forEach(b=>b.addEventListener('click', ()=>{
    modeBtns.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    mode = b.dataset.mode;
    clearCanvas();
  }));

  // Start / Stop
  btnStart.addEventListener('click', ()=>{
    startRecording();
    startMonitor(); // la courbe peut appara√Ætre pendant l‚Äôenregistrement
  });
  btnStop.addEventListener('click', ()=>{
    stopRecording();
  });

  // Exports
  btnWebM.addEventListener('click', ()=>{
    if (!lastBlob) return log('WARN','Rien √† exporter (WebM). Lance un enregistrement, puis Stop.');
    downloadBlob(lastBlob, 'take.webm');
  });
  btnWAV.addEventListener('click', async ()=>{
    if (!lastBlob) return log('WARN','Rien √† exporter (WAV).');
    const wav = await WAVExport.fromWebM(lastBlob);
    if (!wav) return log('ERROR','Conversion WAV impossible.');
    downloadBlob(wav, 'take.wav');
  });
  btnMP3.addEventListener('click', async ()=>{
    if (!lastBlob) return log('WARN','Rien √† exporter (MP3).');
    if (!hasLame) return log('WARN','Encodeur MP3 absent (/src/vendor/lame.min.js).');
    const wav = await WAVExport.fromWebM(lastBlob);
    if (!wav) return log('ERROR','Conversion WAV impossible.');
    const mp3 = await MP3Export.fromWAV(wav);
    if (!mp3) return log('ERROR','Conversion MP3 impossible.');
    downloadBlob(mp3, 'take.mp3');
  });

  function downloadBlob(b, name){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(b);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }

  // Au chargement
  clearCanvas();
  log('INFO', 'Moniteur live OFF par d√©faut.');
  </script>
</body>
</html>
