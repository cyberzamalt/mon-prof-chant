<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Test Audio Core ‚Äî Pitch (cents/notes) + Timeline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220;--panel:#0e1729;--card:#111a2e;--grid:#1a2642;--text:#e5e7eb;--muted:#9ca3af;
      --ok:#10b981;--warn:#f59e0b;--err:#ef4444;--axis:#334155;--orange:#f59e0b;--blue:#3b82f6;--green:#22c55e;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
    .h1{font-weight:800;font-size:20px;margin:8px 0 16px}
    .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #1f2a44;background:var(--card);
      color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .btn.ok{background:#0e1f14;border-color:#173621;color:#c8facc}
    .btn.stop{background:#2a0f14;border-color:#4a171f;color:#fecaca}
    .seg{display:inline-flex;border:1px solid #22304f;background:var(--card);border-radius:12px;overflow:hidden}
    .seg button{padding:8px 12px;border:0;background:transparent;color:var(--text);cursor:pointer}
    .seg button.active{background:#16213a}
    .timer{padding:8px 10px;border:1px solid #22304f;border-radius:10px;background:var(--card);min-width:54px;text-align:center}
    .modes{display:flex;gap:8px;margin:6px 0 10px}
    .mode{border:1px solid #22304f;background:#0f172a;color:#cbd5e1;padding:6px 10px;border-radius:10px;cursor:pointer}
    .mode.active{background:#16213a;color:#fff}
    .noteBox{display:inline-flex;gap:6px;align-items:center;margin-left:10px;color:#cbd5e1}
    .canvasWrap{background:var(--panel);border:1px solid #1f2a44;border-radius:12px;padding:12px}
    .hint{color:var(--muted);font-size:12px;margin:6px 0 12px}
    .legend{display:flex;gap:18px;flex-wrap:wrap;color:#cbd5e1;font-size:12px;margin-top:8px}
    .dot{display:inline-block;width:10px;height:10px;border-radius:2px;margin-right:6px;vertical-align:-1px}
    .d1{background:var(--blue)} .d2{background:#22c55e} .d3{background:var(--orange)}
    .footerBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .log{background:#0b1020;border:1px solid #1f2a44;border-radius:12px;padding:10px;color:#dbeafe;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;max-height:210px;overflow:auto}
    .badge{display:inline-flex;gap:6px;align-items:center;border:1px solid #22304f;background:#0b1220;padding:4px 8px;border-radius:8px}
    .b-ok{color:#bbf7d0;border-color:#206a44;background:#052216}
    .b-warn{color:#fde68a;border-color:#6b4d11;background:#261a06}
    .right{margin-left:auto}
    canvas{display:block;width:100%;height:460px;background:#0b1324;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="h1">üéöÔ∏è Test Audio Core ‚Äî Pitch (cents/notes) + Timeline</div>

    <!-- Barre d‚Äôactions -->
    <div class="bar">
      <button id="btnMic" class="btn">Activer micro</button>

      <span class="seg" id="segMonitor">
        <button data-val="off" class="active">OFF</button>
        <button data-val="on">Moniteur live ON</button>
      </span>

      <div class="seg" id="segRecord">
        <button id="btnStart">‚ñ∂Ô∏é D√©marrer l‚Äôenregistrement</button>
        <button id="btnStop" class="stop">‚ñ† Stop</button>
      </div>

      <div class="timer" id="timer">00:00</div>

      <div class="right seg" id="segZoom">
        <button data-z="1" class="active">x1</button>
        <button data-z="2">x2</button>
        <button data-z="4">x4</button>
      </div>
    </div>

    <!-- Modes d‚Äôaffichage -->
    <div class="modes">
      <div class="mode active" data-mode="cents">Cents (justesse)</div>
      <div class="mode" data-mode="notes">Absolu (notes)</div>
      <span class="noteBox">
        <span id="currentNote">‚Äî</span>
        <span id="offsetCents" title="√©cart en cents par rapport √† la note m√©diane">(+0 c)</span>
      </span>
    </div>

    <!-- Zone graphique -->
    <div class="canvasWrap">
      <div class="hint">La courbe bleue = pitch d√©tect√©. Ligne verte = 0 cent (m√©diane). Le curseur orange n‚Äôappara√Æt que pendant un enregistrement.</div>
      <canvas id="scope" width="1200" height="460"></canvas>

      <div class="legend">
        <span><span class="dot d1"></span>Courbe de pitch (continu)</span>
        <span><span class="dot d2"></span>Ligne m√©diane (0 cent / note de r√©f√©rence)</span>
        <span><span class="dot d3"></span>Curseur temps (enregistrement)</span>
        <span id="pitchyStatus" class="badge b-warn">Pitchy (d√©tection) : <b>non charg√©</b></span>
        <span id="mp3Status" class="badge b-warn">MP3 : <b>encodeur absent</b></span>
      </div>

      <div class="footerBtns">
        <button id="btnWebM" class="btn">‚¨áÔ∏è T√©l√©charger WebM</button>
        <button id="btnWAV" class="btn">üéß Exporter en WAV</button>
        <button id="btnMP3" class="btn" disabled title="Ajoute /src/vendor/lame.min.js pour activer">üéµ Exporter en MP3</button>
      </div>
    </div>

    <div class="h1" style="margin-top:18px">Console</div>
    <pre id="log" class="log">Syst√®me de logs pr√™t‚Ä¶</pre>
  </div>

  <!-- D√©tection locale (YIN compact) -->
  <script src="./src/vendor/pitchy-lite.js"></script>

  <!-- Encodeur MP3 local (si pr√©sent, le bouton se d√©grise) -->
  <script src="./src/vendor/lame.min.js"></script>

  <!-- Exports locaux -->
  <script src="./src/utils/wav-export.js"></script>
  <script src="./src/utils/mp3-export.js"></script>

  <script>
  /***************  Logger ***************/
  const logBox = document.getElementById('log');
  const log = (lvl, msg) => {
    const now = new Date(); const h = String(now.getHours()).padStart(2,'0'); const m = String(now.getMinutes()).padStart(2,'0');
    logBox.textContent += `\n[${h}:${m}] [${lvl}] ${msg}`; logBox.scrollTop = logBox.scrollHeight;
  };

  /***************  UI refs ***************/
  const btnMic   = document.getElementById('btnMic');
  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');
  const timerEl  = document.getElementById('timer');
  const scope    = document.getElementById('scope');
  const ctx      = scope.getContext('2d');
  const pitchyStatus = document.getElementById('pitchyStatus');
  const mp3Status    = document.getElementById('mp3Status');
  const btnWebM = document.getElementById('btnWebM');
  const btnWAV  = document.getElementById('btnWAV');
  const btnMP3  = document.getElementById('btnMP3');
  const segMonitor = document.getElementById('segMonitor');
  const segZoom    = document.getElementById('segZoom');
  const modeBtns   = document.querySelectorAll('.mode');
  const currentNoteEl = document.getElementById('currentNote');
  const offsetEl      = document.getElementById('offsetCents');

  /***************  √âtat ***************/
  let audioCtx = null, micStream = null, analyser = null;
  let mediaRecorder = null, chunks = [], lastBlob = null;
  let monitorLive = false, zoomY = 1, mode = 'cents';
  let rafId = 0, running = false; // boucle de rendu
  let liveStart = 0, recStart = 0;
  const MAX_SEC = 120; // fen√™tre visible (2 min)
  const PAD_LEFT = 60, PAD_RIGHT = 20, PAD_TOP = 20, PAD_BOTTOM = 36;

  // buffer circulaire des points (temps,cents)
  const points = []; // {t,c}
  function resetTimeline() { points.length = 0; }

  // Pitch lib dispo ?
  const hasPitchy = !!window.PitchyLite;
  if (hasPitchy) { pitchyStatus.innerHTML = 'Pitchy (d√©tection) : <b>charg√©</b>'; pitchyStatus.className = 'badge b-ok'; }
  else { log('WARN','Pitchy non charg√© ‚Üí pas de courbe.'); }

  // MP3 dispo ?
  const hasLame = !!(window.MP3Export && window.MP3Export.isReady && window.MP3Export.isReady());
  if (hasLame) { mp3Status.innerHTML = 'MP3 : <b>encodeur pr√™t</b>'; mp3Status.className = 'badge b-ok'; btnMP3.disabled = false; }

  /***************  Axes & mise √† l‚Äô√©chelle ***************/
  function yFromCents(c){
    const vis = 300/zoomY; // -vis..+vis
    const norm = c / (vis||1);
    const h = scope.height - PAD_TOP - PAD_BOTTOM;
    return PAD_TOP + (h/2) - norm*(h/2);
  }
  function xFromSeconds(t){
    const w = scope.width - PAD_LEFT - PAD_RIGHT;
    const clamped = Math.max(0, Math.min(t, MAX_SEC));
    return PAD_LEFT + (w * (clamped / MAX_SEC));
  }

  function drawAxes(){
    // fond
    ctx.fillStyle = '#0b1324'; ctx.fillRect(0,0,scope.width,scope.height);

    // zone trac√©
    ctx.strokeStyle = '#142039'; ctx.lineWidth = 1;
    ctx.strokeRect(PAD_LEFT, PAD_TOP, scope.width-PAD_LEFT-PAD_RIGHT, scope.height-PAD_TOP-PAD_BOTTOM);

    // lignes horizontales (cents)
    ctx.strokeStyle = '#142039'; ctx.beginPath();
    const step = 100/zoomY, max = 300/zoomY;
    for (let c=-max; c<=max; c+=step){
      const y = Math.round(yFromCents(c)) + .5;
      ctx.moveTo(PAD_LEFT, y); ctx.lineTo(scope.width-PAD_RIGHT, y);
    }
    ctx.stroke();

    // m√©diane 0 cent
    ctx.strokeStyle = '#22c55e'; ctx.beginPath();
    const y0 = Math.round(yFromCents(0)) + .5;
    ctx.moveTo(PAD_LEFT, y0); ctx.lineTo(scope.width-PAD_RIGHT, y0); ctx.stroke();

    // labels verticaux (cents √† gauche) + libell√©s √† droite
    ctx.fillStyle = '#9ca3af'; ctx.font = '12px system-ui';
    for (let c=-max; c<=max; c+=step){
      const y = yFromCents(c)+4;
      const lbl = (c>0? '+'+c:c)+' c';
      ctx.fillText(lbl, 8, y);
    }
    ctx.fillText('Tr√®s aigu',  scope.width-84, yFromCents( 250/zoomY)+4);
    ctx.fillText('Aigu',       scope.width-84, yFromCents(  50/zoomY)+4);
    ctx.fillText('Grave',      scope.width-84, yFromCents( -50/zoomY)+4);
    ctx.fillText('Tr√®s grave', scope.width-84, yFromCents(-250/zoomY)+4);

    // axe temps (graduations bas)
    ctx.fillStyle = '#9ca3af';
    const secStep = 10; // toutes les 10s
    for (let s=0; s<=MAX_SEC; s+=secStep){
      const x = Math.round(xFromSeconds(s)) + .5;
      ctx.strokeStyle = '#1a2642';
      ctx.beginPath(); ctx.moveTo(x, scope.height-PAD_BOTTOM); ctx.lineTo(x, scope.height-PAD_BOTTOM+6); ctx.stroke();
      ctx.fillText(String(s)+'s', x-10, scope.height-8);
    }
  }

  function drawCursor(){
    if (!recStart) return;
    const t = audioCtx.currentTime - recStart;
    const x = Math.round(xFromSeconds(t)) + .5;
    ctx.strokeStyle = '#f59e0b';
    ctx.beginPath(); ctx.moveTo(x, PAD_TOP); ctx.lineTo(x, scope.height-PAD_BOTTOM); ctx.stroke();
  }

  function drawCurve(){
    if (!points.length) return;
    ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 1.5; ctx.beginPath();
    for (let i=0;i<points.length;i++){
      const p = points[i];
      const x = xFromSeconds(p.t);
      const y = yFromCents(p.c);
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  function render(){
    drawAxes();
    drawCurve();
    drawCursor();
  }

  /***************  Audio ***************/
  async function ensureAudio(){
    if (audioCtx) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC({ sampleRate: 48000, latencyHint:'interactive' });
    analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;
    log('INFO','AudioEngine pr√™t');
  }
  async function activateMic(){
    await ensureAudio();
    micStream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
    const src = audioCtx.createMediaStreamSource(micStream);
    src.connect(analyser);
    log('INFO','Micro activ√©');
  }

  /***************  D√©tection & boucle ***************/
  function startLoop(){
    if (running) return;
    running = true;
    const det = hasPitchy ? new PitchyLite(audioCtx.sampleRate) : null;
    const buf = new Float32Array(analyser.fftSize);

    const baseStart = recStart || liveStart || 0;

    const tick = ()=>{
      if (!running){ cancelAnimationFrame(rafId); return; }

      drawAxes();

      let tNow = 0;
      if (recStart) tNow = audioCtx.currentTime - recStart;
      else if (monitorLive && liveStart) tNow = audioCtx.currentTime - liveStart;

      if (det && (monitorLive || recStart)){
        analyser.getFloatTimeDomainData(buf);
        const hz = det.detect(buf);
        if (hz){
          const cents = hzToCents(hz, 440); // ref A4 (simple pour test)
          // push point dans fen√™tre [0..MAX_SEC]
          const t = tNow; // temps local (live ou rec)
          points.push({t: Math.max(0, Math.min(t, MAX_SEC)), c: cents});
          // supprime les points hors fen√™tre (glissant)
          while (points.length && points[0].t < tNow - MAX_SEC) points.shift();

          // UI note/cents
          if (mode==='notes'){ currentNoteEl.textContent = hzToNoteName(hz); offsetEl.textContent = ''; }
          else { currentNoteEl.textContent = 'A4'; offsetEl.textContent = `(${Math.round(cents)} c)`; }
        }
      }

      drawCurve();
      drawCursor();

      rafId = requestAnimationFrame(tick);
    };
    tick();
  }
  function stopLoop(){ running = false; cancelAnimationFrame(rafId); render(); }

  /***************  Recorder ***************/
  let timerInt = null;
  function updateTimer(s){
    const mm = String(Math.floor(s/60)).padStart(2,'0');
    const ss = String(Math.floor(s%60)).padStart(2,'0');
    timerEl.textContent = `${mm}:${ss}`;
  }
  function tickTimer(){
    clearInterval(timerInt);
    timerInt = setInterval(()=>{ if (recStart) updateTimer(audioCtx.currentTime - recStart); }, 200);
  }

  function startRecording(){
    if (!micStream) return log('WARN','Active d‚Äôabord le micro.');
    if (!MediaRecorder) return log('ERROR','MediaRecorder non support√©.');

    chunks = []; lastBlob = null; resetTimeline();
    mediaRecorder = new MediaRecorder(micStream, {mimeType:'audio/webm;codecs=opus'});
    mediaRecorder.ondataavailable = e => { if (e.data && e.data.size>0) chunks.push(e.data); };
    mediaRecorder.onstop = ()=>{
      if (chunks.length){ lastBlob = new Blob(chunks,{type:'audio/webm'}); log('INFO','Enregistrement termin√©.'); }
      else { lastBlob = null; log('WARN','Aucun chunk captur√©.'); }
      recStart = 0; updateTimer(0); render();
    };

    recStart = audioCtx.currentTime;
    if (!running) startLoop(); // assure la courbe m√™me si live OFF
    mediaRecorder.start(100);
    log('INFO','Enregistrement en cours‚Ä¶');
    tickTimer();
  }
  function stopRecording(){
    if (mediaRecorder && mediaRecorder.state==='recording') mediaRecorder.stop();
  }

  /***************  Helpers pitch ***************/
  function hzToNoteNumber(hz){ return 69 + 12*Math.log2(hz/440); }
  function hzToNoteName(hz){
    const n = Math.round(hzToNoteNumber(hz));
    const names = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const name = names[(n+1200)%12]; const oct = Math.floor(n/12)-1; return `${name}${oct}`;
  }
  function centsBetween(f1,f2){ return 1200*Math.log2(f1/f2); }
  function hzToCents(hz, refHz){ return centsBetween(hz, refHz); }

  /***************  Actions UI ***************/
  // Micro
  btnMic.addEventListener('click', async ()=>{
    try{
      await activateMic(); btnMic.classList.add('ok');
      render(); // axes visibles d√®s le d√©part
      if (monitorLive && !running){ liveStart = audioCtx.currentTime; startLoop(); }
    }catch(e){ log('ERROR','Micro : '+(e.message||e)); }
  });

  // Moniteur live
  segMonitor.addEventListener('click', e=>{
    if (e.target.tagName!=='BUTTON') return;
    segMonitor.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    monitorLive = (e.target.dataset.val==='on');
    log('INFO','Moniteur live '+(monitorLive?'ON':'OFF'));

    if (monitorLive){
      liveStart = audioCtx?.currentTime || 0;
      if (!running) startLoop();
    }else{
      if (!recStart) stopLoop(); // si pas d‚Äôenregistrement, on peut arr√™ter la boucle
    }
  });

  // Zoom vertical
  segZoom.addEventListener('click', e=>{
    if (e.target.tagName!=='BUTTON') return;
    segZoom.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    zoomY = Number(e.target.dataset.z||'1');
    render();
  });

  // Mode
  modeBtns.forEach(b=>b.addEventListener('click', ()=>{
    modeBtns.forEach(x=>x.classList.remove('active')); b.classList.add('active');
    mode = b.dataset.mode; render();
  }));

  // Start / Stop
  btnStart.addEventListener('click', ()=>{ startRecording(); });
  btnStop.addEventListener('click',  ()=>{ stopRecording(); });

  // Exports
  btnWebM.addEventListener('click', ()=>{
    if (!lastBlob) return log('WARN','Rien √† exporter (WebM).');
    downloadBlob(lastBlob,'take.webm');
  });
  btnWAV.addEventListener('click', async ()=>{
    if (!lastBlob) return log('WARN','Rien √† exporter (WAV).');
    try{
      const wav = await WAVExport.fromWebM(lastBlob); downloadBlob(wav,'take.wav');
    }catch(err){ log('ERROR','WAV: '+(err.message||err)); }
  });
  btnMP3.addEventListener('click', async ()=>{
    if (!lastBlob) return log('WARN','Rien √† exporter (MP3).');
    if (!hasLame) return log('WARN','Encodeur MP3 absent (/src/vendor/lame.min.js).');
    try{
      const wav = await WAVExport.fromWebM(lastBlob);
      const mp3 = await MP3Export.fromWAV(wav);
      downloadBlob(mp3,'take.mp3');
    }catch(err){ log('ERROR','MP3: '+(err.message||err)); }
  });

  function downloadBlob(b,name){
    const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=name; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0);
  }

  // D√©marrage
  render();
  log('INFO','Moniteur live OFF par d√©faut.');
  </script>
</body>
</html>
