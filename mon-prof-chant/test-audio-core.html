<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Test Audio Core ‚Äî Pitch (cents/notes) + Timeline</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --bg:#0b1220;--panel:#0e1729;--card:#111a2e;--grid:#1a2642;--text:#e5e7eb;--muted:#9ca3af;
  --ok:#10b981;--warn:#f59e0b;--err:#ef4444;--blue:#3b82f6;--green:#22c55e;--orange:#f59e0b;--violet:#a78bfa;
  --axis:#334155;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:1180px;margin:24px auto;padding:0 16px}
.h1{font-weight:800;font-size:20px;margin:8px 0 16px}
.bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
.btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #1f2a44;background:var(--card);
  color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
.btn[disabled]{opacity:.45;cursor:not-allowed}
.btn.ok{background:#0e1f14;border-color:#173621;color:#c8facc}
.btn.warn{background:#241a08;border-color:#4b320a;color:#ffe4b5}
.btn.stop{background:#2a0f14;border-color:#4a171f;color:#fecaca}
.seg{display:inline-flex;border:1px solid #22304f;background:var(--card);border-radius:12px;overflow:hidden}
.seg button{padding:8px 12px;border:0;background:transparent;color:var(--text);cursor:pointer}
.seg button.active{background:#16213a}
.timer{padding:8px 10px;border:1px solid #22304f;border-radius:10px;background:var(--card);min-width:54px;text-align:center}
.modes{display:flex;gap:8px;margin:6px 0 10px}
.mode{border:1px solid #22304f;background:#0f172a;color:#cbd5e1;padding:6px 10px;border-radius:10px;cursor:pointer}
.mode.active{background:#16213a;color:#fff}
.noteBox{display:inline-flex;gap:6px;align-items:center;margin-left:10px;color:#cbd5e1}
.cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.panel{background:var(--panel);border:1px solid #1f2a44;border-radius:12px;padding:12px}
.h2{font-weight:800;margin:0 0 8px 0;font-size:14px}
.canvasWrap{border:1px solid #1f2a44;border-radius:10px;padding:12px;background:#0b1324}
.hint{color:var(--muted);font-size:12px;margin:6px 0 10px}
.legend{display:flex;gap:18px;flex-wrap:wrap;color:#cbd5e1;font-size:12px;margin-top:8px}
.dot{display:inline-block;width:10px;height:10px;border-radius:2px;margin-right:6px;vertical-align:-1px}
.d1{background:var(--blue)} .d2{background:var(--green)} .d3{background:var(--orange)} .d4{background:var(--violet)}
.footerBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.log{background:#0b1020;border:1px solid #1f2a44;border-radius:12px;padding:10px;color:#dbeafe;
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:12px;max-height:220px;overflow:auto}
.badge{display:inline-flex;gap:6px;align-items:center;border:1px solid #22304f;background:#0b1220;padding:4px 8px;border-radius:8px}
.b-ok{color:#bbf7d0;border-color:#206a44;background:#052216}
.b-warn{color:#fde68a;border-color:#6b4d11;background:#261a06}
.right{margin-left:auto}
canvas{display:block;width:100%;height:360px;background:#0b1324;border-radius:8px}
.metrics{display:flex;gap:14px;flex-wrap:wrap;margin-top:8px;color:#cbd5e1;font-size:12px}
.metric{background:#0b1220;border:1px solid #22304f;border-radius:8px;padding:6px 10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="h1">üéöÔ∏è Test Audio Core ‚Äî Pitch (cents/notes) + Timeline</div>

  <!-- Barre d‚Äôactions globale -->
  <div class="bar">
    <button id="btnMic" class="btn">Activer micro</button>

    <span class="seg" id="segMonitor">
      <button data-val="off" class="active">Moniteur live</button>
      <button data-val="on">ON</button>
    </span>

    <div class="seg" id="segRecord">
      <button id="btnStart">‚ñ∂Ô∏é D√©marrer l‚Äôenregistrement</button>
      <button id="btnStop" class="stop">‚ñ† Stop</button>
    </div>

    <div class="timer" id="timer">00:00</div>

    <div class="right seg" id="segZoom">
      <button data-z="1" class="active">x1</button>
      <button data-z="2">x2</button>
      <button data-z="4">x4</button>
    </div>
  </div>

  <!-- Modes d‚Äôaffichage -->
  <div class="modes">
    <div class="mode active" data-mode="cents">Cents (justesse)</div>
    <div class="mode" data-mode="notes">Absolu (notes)</div>
    <span class="noteBox">
      <span id="currentNote">‚Äî</span>
      <span id="offsetCents" title="√©cart en cents vs m√©diane">(+0 c)</span>
    </span>
  </div>

  <div class="cols">
    <!-- Panneau A : ta prise -->
    <div class="panel">
      <p class="h2">Ta prise (micro)</p>
      <div class="canvasWrap">
        <div class="hint">La courbe bleue = pitch d√©tect√©. Ligne verte = 0 cent (m√©diane). Le curseur orange appara√Æt uniquement pendant un enregistrement.</div>
        <canvas id="scope" width="1120" height="360"></canvas>
        <div class="legend">
          <span><span class="dot d1"></span>Courbe de pitch (toi)</span>
          <span><span class="dot d2"></span>Ligne m√©diane (0 cent)</span>
          <span><span class="dot d3"></span>Curseur temps (enreg.)</span>
          <span id="pitchyStatus" class="badge b-warn">Pitchy : <b>non charg√©</b></span>
          <span id="mp3Status" class="badge b-warn">MP3 : <b>encodeur absent</b></span>
        </div>
        <div class="footerBtns">
          <button id="btnWebM" class="btn">‚¨áÔ∏è T√©l√©charger WebM</button>
          <button id="btnWAV"  class="btn">üéß Exporter en WAV</button>
          <button id="btnMP3"  class="btn" disabled title="Ajoute /src/vendor/lame.min.js">üéµ Exporter en MP3</button>
        </div>
      </div>
    </div>

    <!-- Panneau B : R√©f√©rence -->
    <div class="panel">
      <p class="h2">R√©f√©rence (chanson)</p>
      <div class="canvasWrap">
        <div class="hint">Charge une r√©f√©rence <b>MP3/WAV</b> locale (ou une URL audio directe). La courbe violette s‚Äôaffiche apr√®s analyse.</div>
        <div class="bar" style="gap:6px;margin:0 0 8px 0">
          <input id="refFile" type="file" accept="audio/*" class="btn" />
          <input id="refUrl"  type="url" placeholder="URL MP3/WAV (pas YouTube)" style="flex:1;min-width:240px;padding:8px;border-radius:10px;border:1px solid #22304f;background:#0f172a;color:#e5e7eb" />
          <button id="btnLoadUrl" class="btn">Charger URL</button>
        </div>
        <canvas id="scopeRef" width="1120" height="200"></canvas>
        <div class="legend">
          <span><span class="dot d4"></span>Courbe de pitch (r√©f√©rence)</span>
        </div>
        <div class="metrics">
          <div class="metric">√âcart moyen: <b id="mAvg">‚Äî</b></div>
          <div class="metric">√âcart max: <b id="mMax">‚Äî</b></div>
          <div class="metric">% dans la zone (¬±25c): <b id="mIn">‚Äî</b></div>
        </div>
      </div>
    </div>
  </div>

  <div class="h1" style="margin-top:18px">Console</div>
  <pre id="log" class="log">Syst√®me de logs pr√™t‚Ä¶</pre>
</div>

<!-- D√©tection de pitch locale (YIN light) -->
<script src="./src/vendor/pitchy-lite.js"></script>
<!-- Exports locaux -->
<script src="./src/utils/wav-export.js"></script>
<script src="./src/utils/mp3-export.js"></script>

<script>
/* ========== Logger ========== */
const logBox = document.getElementById('log');
const log = (lvl,msg)=>{const n=new Date(),h=String(n.getHours()).padStart(2,'0'),m=String(n.getMinutes()).padStart(2,'0');logBox.textContent+=`\\n[${h}:${m}] [${lvl}] ${msg}`;logBox.scrollTop=logBox.scrollHeight;};

/* ========== R√©fs UI ========== */
const btnMic   = document.getElementById('btnMic');
const btnStart = document.getElementById('btnStart');
const btnStop  = document.getElementById('btnStop');
const timerEl  = document.getElementById('timer');
const segMonitor = document.getElementById('segMonitor');
const segZoom    = document.getElementById('segZoom');
const modeBtns   = document.querySelectorAll('.mode');
const currentNoteEl = document.getElementById('currentNote');
const offsetEl      = document.getElementById('offsetCents');

const scope = document.getElementById('scope');
const ctx   = scope.getContext('2d');
const scopeRef = document.getElementById('scopeRef');
const ctxRef   = scopeRef.getContext('2d');

const pitchyStatus = document.getElementById('pitchyStatus');
const mp3Status    = document.getElementById('mp3Status');

const btnWebM = document.getElementById('btnWebM');
const btnWAV  = document.getElementById('btnWAV');
const btnMP3  = document.getElementById('btnMP3');

const refFile  = document.getElementById('refFile');
const refUrl   = document.getElementById('refUrl');
const btnLoadUrl = document.getElementById('btnLoadUrl');

const mAvg = document.getElementById('mAvg');
const mMax = document.getElementById('mMax');
const mIn  = document.getElementById('mIn');

/* ========== √âtat ========== */
let audioCtx=null, analyser=null, micStream=null, mediaRecorder=null, processor=null;
let chunks=[], lastBlob=null, recStart=0, timerInt=null;
let monitorLive=false, zoomY=1, mode='cents';
let rafId=0, ticking=false;
let medianNoteHz=440; // sera fix√© au d√©but d'enregistrement (premi√®re note stable)
let refPitch=[]; // {t,cents}
let refDuration=0;

/* ========== Dispos libs ========== */
const hasPitchy = !!window.PitchyLite;
if (hasPitchy){ pitchyStatus.textContent='Pitchy : charg√©'; pitchyStatus.className='badge b-ok'; }
else { log('WARN','Pitchy non charg√© ‚Äî pas de courbe.'); }

const hasLame = !!(window.MP3Export && window.MP3Export.isReady());
if (hasLame){ mp3Status.textContent='MP3 : encodeur pr√™t'; mp3Status.className='badge b-ok'; btnMP3.disabled=false; }

/* ========== Helpers dessin ========== */
const H = scope.height, W = scope.width;
function mapCentsToY(c){ const norm=c/300; return H/2 - norm*H/2/zoomY; }
function grid(ctx,height,width){
  ctx.fillStyle='#0b1324'; ctx.fillRect(0,0,width,height);
  ctx.strokeStyle='#142039'; ctx.lineWidth=1; ctx.beginPath();
  const step=100/zoomY;
  for(let c=-300;c<=300;c+=step){const y=mapCentsToY(c);ctx.moveTo(0,y);ctx.lineTo(width,y);}
  ctx.stroke();
  ctx.strokeStyle='#22c55e'; ctx.beginPath(); ctx.moveTo(0,height/2); ctx.lineTo(width,height/2); ctx.stroke();
  ctx.fillStyle='#9ca3af'; ctx.font='12px system-ui';
  ctx.fillText('Tr√®s grave', width-80, mapCentsToY(+250));
  ctx.fillText('Grave',      width-80, mapCentsToY(+50));
  ctx.fillText('Aigu',       width-80, mapCentsToY(-50));
  ctx.fillText('Tr√®s aigu',  width-80, mapCentsToY(-250));
}
function drawCursor(){ if(!recStart||!audioCtx) return; const t=audioCtx.currentTime-recStart; const ratio=Math.min(t/120,1); const x=40+(W-60)*ratio; ctx.strokeStyle='#f59e0b'; ctx.beginPath(); ctx.moveTo(x,10); ctx.lineTo(x,H-10); ctx.stroke(); }

/* ========== Audio Live ========== */
async function ensureAudio(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)({sampleRate:48000, latencyHint:'interactive'});
  analyser = audioCtx.createAnalyser(); analyser.fftSize=2048;
  processor = audioCtx.createScriptProcessor(2048,1,1);
  log('INFO','AudioEngine pr√™t');
}
async function activateMic(){
  await ensureAudio();
  micStream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
  const src = audioCtx.createMediaStreamSource(micStream);
  src.connect(analyser);
  processor.connect(audioCtx.destination);
  log('INFO','Micro activ√©');
}
function hzToNoteNumber(hz){ return 69+12*Math.log2(hz/440); }
function hzToNoteName(hz){ const n=Math.round(hzToNoteNumber(hz)); const names=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; const name=names[(n+1200)%12]; const oct=Math.floor(n/12)-1; return name+oct; }
function centsBetween(f1,f2){ return 1200*Math.log2(f1/f2); }
function hzToCents(hz,ref){ return centsBetween(hz,ref); }

function startMonitor(){
  if(!hasPitchy||!analyser) return;
  if(ticking) return;
  ticking=true;
  const det = new PitchyLite(audioCtx.sampleRate);
  const buf = new Float32Array(analyser.fftSize);

  const tick=()=>{
    if(!ticking) return;
    grid(ctx,H,W);
    if (monitorLive || (mediaRecorder && mediaRecorder.state==='recording')){
      analyser.getFloatTimeDomainData(buf);
      const hz = det.detect(buf); // null si silence
      if (hz){
        const cents = hzToCents(hz, medianNoteHz);
        const t = recStart? (audioCtx.currentTime-recStart) : 0;
        const x = 40 + (W-60)*Math.min(t/120,1);
        const y = mapCentsToY(cents);
        ctx.fillStyle='var(--blue)';
        ctx.beginPath(); ctx.arc(x,y,2.2,0,Math.PI*2); ctx.fill();

        if (mode==='notes'){ currentNoteEl.textContent=hzToNoteName(hz); offsetEl.textContent=''; }
        else { currentNoteEl.textContent=hzToNoteName(medianNoteHz); offsetEl.textContent=`(${Math.round(cents)} c)`; }
      }
      drawCursor();
    }
    rafId=requestAnimationFrame(tick);
  };
  tick();
}
function stopMonitor(){ ticking=false; cancelAnimationFrame(rafId); grid(ctx,H,W); }

/* ========== Recorder ========== */
function updateTimer(s){ const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(Math.floor(s%60)).padStart(2,'0'); timerEl.textContent=`${mm}:${ss}`; }
function tickTimer(){ clearInterval(timerInt); timerInt=setInterval(()=>{ if(!recStart) return; updateTimer(audioCtx.currentTime-recStart); },250); }

function startRecording(){
  if(!micStream){ log('WARN','Active d‚Äôabord le micro.'); return; }
  chunks=[]; lastBlob=null;
  mediaRecorder=new MediaRecorder(micStream,{mimeType:'audio/webm;codecs=opus'});
  mediaRecorder.ondataavailable=e=>{ if(e.data&&e.data.size>0) chunks.push(e.data); };
  mediaRecorder.onstop=()=>{
    if(chunks.length){ lastBlob=new Blob(chunks,{type:'audio/webm'}); log('INFO','Enregistrement termin√©.'); }
    else { lastBlob=null; log('WARN','Aucun chunk captur√©.'); }
    recStart=0; updateTimer(0);
  };
  mediaRecorder.start(100);
  // fixe la m√©diane √† la premi√®re valeur stable rencontr√©e; ici on prend A4=440 comme rep√®re initial
  medianNoteHz=440;
  recStart=audioCtx.currentTime; log('INFO','Enregistrement en cours‚Ä¶'); tickTimer();
  startMonitor();
}
function stopRecording(){ if(mediaRecorder && mediaRecorder.state==='recording'){ mediaRecorder.stop(); } }

/* ========== Exports ========== */
btnWebM.onclick=()=>{ if(!lastBlob) return log('WARN','Rien √† exporter (WebM).'); downloadBlob(lastBlob,'take.webm'); };
btnWAV.onclick=async()=>{
  if(!lastBlob) return log('WARN','Rien √† exporter (WAV).');
  if(!window.WAVExport) return log('ERROR','WAVExport indisponible.');
  const wav=await WAVExport.fromWebM(lastBlob);
  if(!wav) return log('ERROR','Conversion WAV impossible.');
  downloadBlob(wav,'take.wav');
};
btnMP3.onclick=async()=>{
  if(!lastBlob) return log('WARN','Rien √† exporter (MP3).');
  if(!hasLame) return log('WARN','Encodeur MP3 absent (/src/vendor/lame.min.js).');
  const wav=await WAVExport.fromWebM(lastBlob);
  if(!wav) return log('ERROR','Conversion WAV impossible.');
  const mp3=await MP3Export.fromWAV(wav);
  if(!mp3) return log('ERROR','Conversion MP3 impossible.');
  downloadBlob(mp3,'take.mp3');
};
function downloadBlob(b,name){ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=name; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); }

/* ========== R√©f√©rence (chargement & pitch offline) ========== */
refFile.addEventListener('change', async(e)=>{ const f=e.target.files[0]; if(!f) return;
  const url=URL.createObjectURL(f); await loadReference(url,true); URL.revokeObjectURL(url);
});
btnLoadUrl.addEventListener('click', async()=>{ const u=refUrl.value.trim(); if(!u) return; await loadReference(u,false); });
async function loadReference(url,isBlob){
  try{
    await ensureAudio();
    const arr = await (await fetch(url)).arrayBuffer();
    const buf = await audioCtx.decodeAudioData(arr);
    const ch = buf.getChannelData(0); refDuration=buf.duration;
    refPitch = extractPitchOffline(ch, buf.sampleRate);
    drawReference();
    log('INFO', `R√©f√©rence charg√©e (${Math.round(buf.duration)}s, ${refPitch.length} pts).`);
    recomputeMetrics(); // si des points live existent plus tard, on mettra √† jour
  }catch(e){ log('ERROR','R√©f√©rence: '+(e.message||e)); }
}
function extractPitchOffline(samples, sr){
  const det = new PitchyLite(sr);
  const win = 2048, hop = 512;
  const out=[];
  for(let i=0;i+win<=samples.length;i+=hop){
    const slice = samples.subarray(i,i+win);
    const hz = det.detect(slice);
    const t = i/sr;
    if(hz){ const cents=hzToCents(hz,440); out.push({t,cents}); }
  }
  return out;
}
function drawReference(){
  ctxRef.clearRect(0,0,scopeRef.width,scopeRef.height);
  // grille l√©g√®re
  ctxRef.fillStyle='#0b1324'; ctxRef.fillRect(0,0,scopeRef.width,scopeRef.height);
  ctxRef.strokeStyle='#142039'; ctxRef.beginPath();
  for(let y=0;y<=scopeRef.height;y+=40){ ctxRef.moveTo(0,y); ctxRef.lineTo(scopeRef.width,y); }
  ctxRef.stroke();

  if(!refPitch.length) return;
  ctxRef.fillStyle='var(--violet)';
  for(const p of refPitch){
    const x = (p.t / Math.max(refDuration,120)) * (scopeRef.width-40) + 20;
    const y = scopeRef.height/2 - (p.cents/300)*scopeRef.height/2;
    ctxRef.fillRect(x,y,2,2);
  }
}

/* ========== Metrics simple (comparaison) ========== */
function recomputeMetrics(){
  // On compare les temps de ta courbe (enregistrement) avec la r√©f ; ici on prend l‚Äôinstantan√© courant (faible live)
  // MVP : si pas d‚Äôenregistrement, on laisse ‚Äú‚Äî‚Äù.
  if(!refPitch.length) { mAvg.textContent='‚Äî'; mMax.textContent='‚Äî'; mIn.textContent='‚Äî'; return; }
  // Dans cette version MVP la courbe live n‚Äôest pas √©chantillonn√©e ; on mettra √† jour quand on enregistrera la piste
}

/* ========== Interactions ========== */
btnMic.onclick = async()=>{ try{ await activateMic(); btnMic.classList.add('ok'); if(monitorLive) startMonitor(); else { grid(ctx,H,W);} }catch(e){ log('ERROR','Micro: '+(e.message||e)); }};
segMonitor.onclick = (e)=>{ if(e.target.tagName!=='BUTTON') return; const val=e.target.dataset.val; segMonitor.querySelectorAll('button').forEach(b=>b.classList.toggle('active',b===e.target)); monitorLive=(val==='on'); log('INFO',`Moniteur live ${monitorLive?'ON':'OFF'}`); if(monitorLive) startMonitor(); else stopMonitor(); };
segZoom.onclick = (e)=>{ if(e.target.tagName!=='BUTTON') return; zoomY=Number(e.target.dataset.z||'1'); segZoom.querySelectorAll('button').forEach(b=>b.classList.toggle('active',b===e.target)); grid(ctx,H,W); };
modeBtns.forEach(b=>b.onclick=()=>{ modeBtns.forEach(x=>x.classList.remove('active')); b.classList.add('active'); mode=b.dataset.mode; grid(ctx,H,W); });

btnStart.onclick = ()=>{ startRecording(); };
btnStop.onclick  = ()=>{ stopRecording(); };

grid(ctx,H,W);
ctxRef.fillStyle='#0b1324'; ctxRef.fillRect(0,0,scopeRef.width,scopeRef.height);
log('INFO','Moniteur live OFF par d√©faut.');
</script>
</body>
</html>
