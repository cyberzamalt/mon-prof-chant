<!-- test-audio-core.html -->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Test Audio Core ‚Äì Mon Prof Chant</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 8px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; align-items: center; }
    button, input[type="file"] { padding: 8px 12px; font-size: 14px; }
    fieldset { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin: 16px 0; }
    legend { padding: 0 8px; color: #333; }
    .tag { display: inline-block; font-size: 12px; background:#f3f5f7; border:1px solid #e5e8eb; padding:2px 6px; border-radius:6px; }
    .muted { color: #666; font-size: 13px; }
    audio { width: 100%; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>Test Audio Core <span class="tag">micro + export + fichier de r√©f√©rence</span></h1>
  <p class="muted">Page de test minimale bas√©e sur <code>RecorderService</code>. Rien d‚Äôintrusif : pas de d√©pendances UI externes, pas de changement sur vos modules.</p>

  <fieldset>
    <legend>üéôÔ∏è Enregistrement micro</legend>
    <div class="row">
      <button id="btnStart">Start</button>
      <button id="btnPause" disabled>Pause</button>
      <button id="btnResume" disabled>Resume</button>
      <button id="btnStop" disabled>Stop</button>
      <span id="status" class="muted">‚Äì</span>
    </div>
    <audio id="player" controls></audio>
    <div class="row" style="margin-top:8px">
      <button id="btnWav" disabled>T√©l√©charger WAV</button>
      <button id="btnMp3" disabled>T√©l√©charger MP3</button>
      <button id="btnWebM" disabled>T√©l√©charger WebM</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>üéµ R√©f√©rence (fichier)</legend>
    <div class="row">
      <input id="refFile" type="file" accept="audio/*" />
      <button id="btnLoadRef">Charger le fichier</button>
      <span id="refStatus" class="muted">‚Äì</span>
    </div>
    <audio id="refPlayer" controls></audio>
  </fieldset>

  <script type="module">
    import RecorderService from './src/audio/recording/RecorderService.js';

    const btnStart  = document.getElementById('btnStart');
    const btnPause  = document.getElementById('btnPause');
    const btnResume = document.getElementById('btnResume');
    const btnStop   = document.getElementById('btnStop');
    const statusEl  = document.getElementById('status');
    const player    = document.getElementById('player');

    const btnWav  = document.getElementById('btnWav');
    const btnMp3  = document.getElementById('btnMp3');
    const btnWebM = document.getElementById('btnWebM');

    const refFile    = document.getElementById('refFile');
    const btnLoadRef = document.getElementById('btnLoadRef');
    const refStatus  = document.getElementById('refStatus');
    const refPlayer  = document.getElementById('refPlayer');

    let stream = null;
    const rec = new RecorderService();

    // --- helpers UI ---
    function setRecState(state) {
      // states: idle | recording | paused | stopped
      btnStart.disabled  = (state !== 'idle' && state !== 'stopped');
      btnPause.disabled  = (state !== 'recording');
      btnResume.disabled = (state !== 'paused');
      btnStop.disabled   = (state !== 'recording' && state !== 'paused');

      const hasBlob = !!rec.getBlob();
      btnWav.disabled  = !hasBlob;
      btnMp3.disabled  = !hasBlob;
      btnWebM.disabled = !hasBlob;
    }

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    // --- events ---
    rec.on('start', () => setStatus('Enregistrement en cours‚Ä¶'));
    rec.on('pause', () => setStatus('En pause'));
    rec.on('resume', () => setStatus('Reprise'));
    rec.on('stop',  () => setStatus('Arr√™t√©'));
    rec.on('blob',  (blob) => {
      // pr√©pare la r√©√©coute
      try { URL.revokeObjectURL(player.src); } catch {}
      player.src = URL.createObjectURL(blob);
    });
    rec.on('error', (e) => setStatus('Erreur : ' + (e?.message || e)));

    // --- boutons micro ---
    btnStart.addEventListener('click', async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        await rec.start(stream);
        setRecState('recording');
      } catch (e) {
        setStatus('Permission micro refus√©e ou erreur');
      }
    });

    btnPause.addEventListener('click', () => {
      rec.pause();
      setRecState('paused');
    });

    btnResume.addEventListener('click', () => {
      rec.resume();
      setRecState('recording');
    });

    btnStop.addEventListener('click', async () => {
      await rec.stop();
      // Lib√®re le micro si besoin
      try { stream?.getTracks()?.forEach(t => t.stop()); } catch {}
      setRecState('stopped');
    });

    // --- downloads ---
    btnWav.addEventListener('click', () => rec.downloadWav?.('take.wav'));
    btnMp3.addEventListener('click', () => rec.downloadMp3?.('take.mp3'));
    btnWebM.addEventListener('click', () => rec.downloadWebM?.('take.webm'));

    // --- fichier de r√©f√©rence ---
    btnLoadRef.addEventListener('click', async () => {
      const file = refFile.files?.[0];
      if (!file) { refStatus.textContent = 'Choisis un fichier audio.'; return; }

      // Charge via Recorder (conserve le m√™me chemin d‚Äôacc√®s et tes utilitaires)
      try {
        const ret = await rec.loadFile(file);
        // Affiche la r√©f√©rence pour √©coute
        try { URL.revokeObjectURL(refPlayer.src); } catch {}
        refPlayer.src = URL.createObjectURL(file);

        // Indication de chargement ok (analyse √† brancher dans tes modules existants)
        const sizeKb = Math.round(file.size / 1024);
        refStatus.textContent = `R√©f√©rence charg√©e (${sizeKb} KB). Pr√™te pour l‚Äôanalyse.`;
      } catch (e) {
        refStatus.textContent = 'Erreur de chargement : ' + (e?.message || e);
      }
    });

    // √©tat initial
    setRecState('idle');
    setStatus('Pr√™t');
    refStatus.textContent = '‚Äì';
  </script>
</body>
</html>
