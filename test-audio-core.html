<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Test Audio Core ‚Äî Pitch Detection + Recording</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root {
  --bg: #0b1220;
  --panel: #0e1729;
  --card: #111a2e;
  --grid: #1a2642;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --ok: #10b981;
  --err: #ef4444;
  --blue: #3b82f6;
  --green: #22c55e;
  --orange: #f59e0b;
}

* { box-sizing: border-box; }
html, body { height: 100%; margin: 0; }
body {
  background: var(--bg);
  color: var(--text);
  font: 14px/1.45 system-ui, Segoe UI, Roboto, Arial;
  padding: 0;
}

.wrap {
  max-width: 1400px;
  margin: 20px auto;
  padding: 0 16px;
}

.h1 {
  font-weight: 800;
  font-size: 20px;
  margin: 0 0 16px 0;
}

.h2 {
  font-weight: 700;
  font-size: 14px;
  margin: 0 0 8px 0;
}

.bar {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  margin-bottom: 12px;
}

.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 1px solid #1f2a44;
  background: var(--card);
  color: var(--text);
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  transition: all 0.2s;
}

.btn:hover:not([disabled]) {
  background: #16213a;
  border-color: #2a3a54;
}

.btn[disabled] {
  opacity: 0.4;
  cursor: not-allowed;
}

.btn.ok {
  background: #0e1f14;
  border-color: #173621;
  color: #c8facc;
}

.btn.err {
  background: #2a0f14;
  border-color: #4a171f;
  color: #fecaca;
}

.seg {
  display: inline-flex;
  border: 1px solid #22304f;
  background: var(--card);
  border-radius: 8px;
  overflow: hidden;
}

.seg button {
  padding: 8px 12px;
  border: 0;
  background: transparent;
  color: var(--text);
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
}

.seg button.active {
  background: #16213a;
  color: #22c55e;
}

.timer {
  padding: 8px 12px;
  border: 1px solid #22304f;
  border-radius: 8px;
  background: var(--card);
  min-width: 60px;
  text-align: center;
  font-weight: 600;
  font-family: monospace;
}

.cols {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
}

@media (max-width: 1024px) {
  .cols {
    grid-template-columns: 1fr;
  }
}

.panel {
  background: var(--panel);
  border: 1px solid #1f2a44;
  border-radius: 12px;
  padding: 16px;
}

.canvasWrap {
  border: 1px solid #1f2a44;
  border-radius: 8px;
  padding: 8px;
  background: #0b1324;
  margin: 8px 0;
}

canvas {
  display: block;
  width: 100%;
  height: auto;
  background: #0b1324;
  border-radius: 6px;
}

.controls {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 8px;
}

.log {
  background: #0b1020;
  border: 1px solid #1f2a44;
  border-radius: 8px;
  padding: 12px;
  color: #dbeafe;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  font-size: 12px;
  max-height: 250px;
  overflow-y: auto;
  white-space: pre-wrap;
  word-break: break-word;
}

.badge {
  display: inline-flex;
  gap: 6px;
  align-items: center;
  border: 1px solid #22304f;
  background: #0b1220;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
}

.badge.ok {
  color: #bbf7d0;
  border-color: #206a44;
  background: #052216;
}

.badge.warn {
  color: #fde68a;
  border-color: #6b4d11;
  background: #261a06;
}

.hint {
  color: var(--muted);
  font-size: 12px;
  margin: 6px 0 8px 0;
}

.right {
  margin-left: auto;
}

input[type="file"],
input[type="url"] {
  padding: 8px 12px;
  border: 1px solid #22304f;
  border-radius: 8px;
  background: #0f172a;
  color: var(--text);
  font-size: 13px;
}

.metrics {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 8px;
  font-size: 12px;
}

.metric {
  background: #0b1220;
  border: 1px solid #22304f;
  border-radius: 6px;
  padding: 6px 10px;
}
</style>
</head>
<body>

<div class="wrap">
  <div class="h1">üéµ Test Audio Core ‚Äî Enregistrement + D√©tection Pitch</div>

  <!-- ACTIONS PRINCIPALES -->
  <div class="bar">
    <button id="btnMic" class="btn">üé§ Activer micro</button>

    <div class="seg">
      <button id="btnRecStart" class="btn">‚ñ∂ Enregistrer</button>
      <button id="btnRecStop" class="btn err" disabled>‚èπ Stop</button>
    </div>

    <div class="timer" id="timerRec">00:00</div>

    <div class="seg">
      <button id="btnMonOff" class="btn active">Moniteur OFF</button>
      <button id="btnMonOn" class="btn">Moniteur ON</button>
    </div>

    <span class="right badge warn" id="pitchyStatus">PitchyLite: chargement...</span>
  </div>

  <!-- DEUX COLONNES : ENREGISTREMENT + R√âF√âRENCE -->
  <div class="cols">
    <!-- COLONNE 1 : TA PRISE -->
    <div class="panel">
      <p class="h2">üéôÔ∏è Ta prise (micro)</p>
      <div class="hint">Courbe bleue = ton pitch. Ligne verte = r√©f√©rence (440 Hz).</div>
      <div class="canvasWrap">
        <canvas id="canvasRec" width="500" height="280"></canvas>
      </div>
      <div class="controls">
        <button id="btnDownWebM" class="btn">‚¨áÔ∏è WebM</button>
        <button id="btnDownWAV" class="btn">üéß WAV</button>
        <button id="btnDownMP3" class="btn">üéµ MP3</button>
        <button id="btnClearRec" class="btn">üóëÔ∏è Effacer</button>
        <input type="file" id="fileUploadRec" accept="audio/*" class="btn" style="border:1px solid #22304f;padding:8px 12px;cursor:pointer" />
      </div>
    </div>

    <!-- COLONNE 2 : R√âF√âRENCE -->
    <div class="panel">
      <p class="h2">üéº R√©f√©rence (comparaison)</p>
      <div class="hint">Charge un MP3/WAV local pour comparer ta courbe.</div>
      <div class="canvasWrap">
        <canvas id="canvasRef" width="500" height="280"></canvas>
      </div>
      <div class="controls">
        <input type="file" id="fileUploadRef" accept="audio/*" class="btn" style="border:1px solid #22304f;padding:8px 12px;cursor:pointer" />
        <button id="btnClearRef" class="btn">üóëÔ∏è Effacer</button>
      </div>
      <div class="metrics" id="metricsRef">
        <div class="metric">√âcart moy: <b id="mAvg">‚Äî</b></div>
        <div class="metric">√âcart max: <b id="mMax">‚Äî</b></div>
        <div class="metric">% juste: <b id="mInTune">‚Äî</b></div>
      </div>
    </div>
  </div>

  <!-- CONSOLE DE LOGS -->
  <div class="h1">üìã Logs</div>
  <div id="logBox" class="log">D√©marrage...</div>
</div>

<!-- LIBRARIES -->
<script src="./src/vendor/pitchy-lite.js"></script>
<script src="./src/utils/wav-export.js"></script>
<script src="./src/utils/mp3-export.js"></script>

<script>
/* ==================== LOGGER ==================== */
const logBox = document.getElementById('logBox');
const log = (level, msg) => {
  const now = new Date();
  const h = String(now.getHours()).padStart(2, '0');
  const m = String(now.getMinutes()).padStart(2, '0');
  const s = String(now.getSeconds()).padStart(2, '0');
  const line = `[${h}:${m}:${s}] [${level}] ${msg}`;
  logBox.textContent += line + '\n';
  logBox.scrollTop = logBox.scrollHeight;
};

log('INFO', 'Syst√®me d√©marr√©');

/* ==================== DOM REFS ==================== */
const btnMic = document.getElementById('btnMic');
const btnRecStart = document.getElementById('btnRecStart');
const btnRecStop = document.getElementById('btnRecStop');
const timerRec = document.getElementById('timerRec');
const btnMonOff = document.getElementById('btnMonOff');
const btnMonOn = document.getElementById('btnMonOn');
const pitchyStatus = document.getElementById('pitchyStatus');

const canvasRec = document.getElementById('canvasRec');
const ctxRec = canvasRec.getContext('2d');
const canvasRef = document.getElementById('canvasRef');
const ctxRef = canvasRef.getContext('2d');

const btnDownWebM = document.getElementById('btnDownWebM');
const btnDownWAV = document.getElementById('btnDownWAV');
const btnDownMP3 = document.getElementById('btnDownMP3');
const btnClearRec = document.getElementById('btnClearRec');
const fileUploadRec = document.getElementById('fileUploadRec');

const fileUploadRef = document.getElementById('fileUploadRef');
const btnClearRef = document.getElementById('btnClearRef');

const mAvg = document.getElementById('mAvg');
const mMax = document.getElementById('mMax');
const mInTune = document.getElementById('mInTune');

/* ==================== STATE ==================== */
let audioCtx = null;
let analyser = null;
let micStream = null;
let mediaRecorder = null;
let chunks = [];
let lastBlob = null;

let recStart = 0;
let timerInterval = null;
let rafId = null;
let monitorOn = false;
let detector = null;

let refData = { pitch: [], duration: 0 };

/* ==================== CANVAS SETUP ==================== */
function clearCanvas(canvas, ctx) {
  ctx.fillStyle = '#0b1324';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Grille l√©g√®re
  ctx.strokeStyle = '#1a2642';
  ctx.lineWidth = 1;
  for (let y = 0; y <= canvas.height; y += 40) {
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(canvas.width, y);
    ctx.stroke();
  }

  // Ligne m√©diane (440 Hz = 0 cents)
  ctx.strokeStyle = '#22c55e';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(0, canvas.height / 2);
  ctx.lineTo(canvas.width, canvas.height / 2);
  ctx.stroke();
}

function hzToCents(hz, ref = 440) {
  return 1200 * Math.log2(hz / ref);
}

function mapCentsToY(cents, height, zoomY = 1) {
  const norm = cents / 300;
  return height / 2 - (norm * height / 2) / zoomY;
}

clearCanvas(canvasRec, ctxRec);
clearCanvas(canvasRef, ctxRef);

/* ==================== AUDIO INIT ==================== */
async function ensureAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)({
    sampleRate: 48000,
    latencyHint: 'interactive',
  });
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  log('INFO', 'AudioContext cr√©√© (48kHz)');
}

async function activateMic() {
  try {
    await ensureAudio();
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const src = audioCtx.createMediaStreamSource(micStream);
    src.connect(analyser);
    log('INFO', 'Micro activ√©');
    btnMic.classList.add('ok');
    btnMic.disabled = true;
  } catch (err) {
    log('ERROR', 'Micro: ' + err.message);
  }
}

/* ==================== PITCH DETECTION ==================== */
function initDetector() {
  if (typeof PitchyLite === 'undefined') {
    log('ERROR', 'PitchyLite non disponible');
    pitchyStatus.textContent = 'PitchyLite: ERREUR';
    pitchyStatus.className = 'badge err';
    return false;
  }

  detector = new PitchyLite(audioCtx.sampleRate);
  log('INFO', 'D√©tecteur pitch initialis√©');
  pitchyStatus.textContent = 'PitchyLite: OK';
  pitchyStatus.className = 'badge ok';
  return true;
}

/* ==================== RECORDING ==================== */
function updateTimer(secs) {
  const mm = String(Math.floor(secs / 60)).padStart(2, '0');
  const ss = String(Math.floor(secs % 60)).padStart(2, '0');
  timerRec.textContent = `${mm}:${ss}`;
}

function startRecording() {
  if (!micStream) {
    log('WARN', 'Activez d\'abord le micro');
    return;
  }

  if (!detector) {
    initDetector();
  }

  chunks = [];
  lastBlob = null;
  recStart = audioCtx.currentTime;

  const options = {
    mimeType: 'audio/webm;codecs=opus',
    audioBitsPerSecond: 128000,
  };

  mediaRecorder = new MediaRecorder(micStream, options);
  mediaRecorder.ondataavailable = (e) => {
    if (e.data && e.data.size > 0) {
      chunks.push(e.data);
    }
  };
  mediaRecorder.onstop = () => {
    if (chunks.length > 0) {
      lastBlob = new Blob(chunks, { type: 'audio/webm' });
      log('INFO', 'Enregistrement termin√©');
    }
  };

  mediaRecorder.start(100);
  btnRecStart.disabled = true;
  btnRecStop.disabled = false;

  timerInterval = setInterval(() => {
    const elapsed = audioCtx.currentTime - recStart;
    updateTimer(elapsed);
  }, 100);

  log('INFO', 'Enregistrement d√©marr√©');
  startMonitor();
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    btnRecStart.disabled = false;
    btnRecStop.disabled = true;
    clearInterval(timerInterval);
    updateTimer(0);
    stopMonitor();
  }
}

/* ==================== MONITOR LIVE ==================== */
function startMonitor() {
  if (!detector || !analyser) return;
  if (rafId) return;

  const buf = new Float32Array(analyser.fftSize);

  function tick() {
    clearCanvas(canvasRec, ctxRec);

    analyser.getFloatTimeDomainData(buf);
    const hz = detector.detect(buf);

    if (hz) {
      const cents = hzToCents(hz, 440);
      const elapsed = audioCtx.currentTime - recStart;
      const x = 20 + (canvasRec.width - 40) * Math.min(elapsed / 120, 1);
      const y = mapCentsToY(cents, canvasRec.height);

      // Dessiner point
      ctxRec.fillStyle = '#3b82f6';
      ctxRec.beginPath();
      ctxRec.arc(x, y, 3, 0, Math.PI * 2);
      ctxRec.fill();
    }

    if (monitorOn || (mediaRecorder && mediaRecorder.state === 'recording')) {
      rafId = requestAnimationFrame(tick);
    }
  }

  tick();
}

function stopMonitor() {
  if (rafId) {
    cancelAnimationFrame(rafId);
    rafId = null;
  }
  clearCanvas(canvasRec, ctxRec);
}

/* ==================== EXPORTS ==================== */
function downloadBlob(blob, name) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = name;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  log('INFO', `T√©l√©charg√©: ${name}`);
}

btnDownWebM.onclick = () => {
  if (!lastBlob) return log('WARN', 'Aucun enregistrement');
  downloadBlob(lastBlob, 'take.webm');
};

btnDownWAV.onclick = async () => {
  if (!lastBlob) return log('WARN', 'Aucun enregistrement');
  if (!window.WAVExport) return log('ERROR', 'WAVExport indisponible');
  const wav = await WAVExport.fromWebM(lastBlob);
  if (!wav) return log('ERROR', 'Conversion WAV √©chou√©e');
  downloadBlob(wav, 'take.wav');
};

btnDownMP3.onclick = async () => {
  if (!lastBlob) return log('WARN', 'Aucun enregistrement');
  if (!window.WAVExport) return log('ERROR', 'WAVExport indisponible');
  if (!window.MP3Export) return log('ERROR', 'MP3Export indisponible');

  const wav = await WAVExport.fromWebM(lastBlob);
  if (!wav) return log('ERROR', 'Conversion WAV √©chou√©e');

  const mp3 = await MP3Export.fromWav(wav);
  if (!mp3) return log('ERROR', 'Conversion MP3 √©chou√©e');

  downloadBlob(mp3, 'take.mp3');
};

btnClearRec.onclick = () => {
  chunks = [];
  lastBlob = null;
  updateTimer(0);
  clearCanvas(canvasRec, ctxRec);
  log('INFO', 'Enregistrement effac√©');
};

/* ==================== FILE UPLOADS ==================== */
fileUploadRec.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  try {
    await ensureAudio();
    const buf = await file.arrayBuffer();
    lastBlob = new Blob([buf], { type: file.type });
    chunks = [new Blob([buf], { type: file.type })];
    log('INFO', `Fichier charg√©: ${file.name}`);
  } catch (err) {
    log('ERROR', 'Upload rec: ' + err.message);
  }
});

fileUploadRef.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  try {
    await ensureAudio();
    const buf = await file.arrayBuffer();
    const audio = await audioCtx.decodeAudioData(buf);
    const ch = audio.getChannelData(0);
    refData.duration = audio.duration;
    refData.pitch = extractPitch(ch, audio.sampleRate);
    drawReference();
    log('INFO', `R√©f√©rence charg√©e: ${file.name}`);
  } catch (err) {
    log('ERROR', 'Upload ref: ' + err.message);
  }
});

btnClearRef.onclick = () => {
  refData = { pitch: [], duration: 0 };
  clearCanvas(canvasRef, ctxRef);
  log('INFO', 'R√©f√©rence effac√©e');
};

/* ==================== PITCH EXTRACTION (OFFLINE) ==================== */
function extractPitch(samples, sr) {
  if (!detector) return [];

  const result = [];
  const win = 2048;
  const hop = 512;

  for (let i = 0; i + win <= samples.length; i += hop) {
    const slice = samples.subarray(i, i + win);
    const hz = detector.detect(slice);
    if (hz) {
      const t = i / sr;
      const cents = hzToCents(hz, 440);
      result.push({ t, hz, cents });
    }
  }

  return result;
}

/* ==================== REFERENCE DRAWING ==================== */
function drawReference() {
  clearCanvas(canvasRef, ctxRef);

  if (refData.pitch.length === 0) return;

  ctxRef.strokeStyle = '#a78bfa';
  ctxRef.lineWidth = 2;
  ctxRef.beginPath();

  let first = true;
  for (const p of refData.pitch) {
    const x = 20 + (canvasRef.width - 40) * (p.t / Math.max(refData.duration, 1));
    const y = mapCentsToY(p.cents, canvasRef.height);

    if (first) {
      ctxRef.moveTo(x, y);
      first = false;
    } else {
      ctxRef.lineTo(x, y);
    }
  }

  ctxRef.stroke();

  // Stats simples
  if (refData.pitch.length > 0) {
    const devs = refData.pitch.map(p => Math.abs(p.cents));
    const avg = devs.reduce((a, b) => a + b, 0) / devs.length;
    const max = Math.max(...devs);
    const inTune = refData.pitch.filter(p => Math.abs(p.cents) < 25).length / refData.pitch.length * 100;

    mAvg.textContent = avg.toFixed(1) + 'c';
    mMax.textContent = max.toFixed(1) + 'c';
    mInTune.textContent = inTune.toFixed(1) + '%';
  }
}

/* ==================== EVENT LISTENERS ==================== */
btnMic.onclick = () => activateMic();

btnRecStart.onclick = () => startRecording();
btnRecStop.onclick = () => stopRecording();

btnMonOff.onclick = () => {
  monitorOn = false;
  btnMonOff.classList.add('active');
  btnMonOn.classList.remove('active');
  stopMonitor();
  log('INFO', 'Moniteur OFF');
};

btnMonOn.onclick = () => {
  monitorOn = true;
  btnMonOn.classList.add('active');
  btnMonOff.classList.remove('active');
  if (audioCtx) startMonitor();
  log('INFO', 'Moniteur ON');
};

log('INFO', 'Interface pr√™te');
</script>

</body>
</html>
