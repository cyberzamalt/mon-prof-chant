<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Test Audio Core ‚Äî Pitch (cents/notes) + Timeline (ligne m√©diane)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220;--card:#0f172a;--ink:#e5e7eb;--muted:#9ca3af;
      --ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--brand:#6366f1;
      --axis:#334155;--grid:#1f2937;--accent:#38bdf8;--mid:#94a3b8;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:980px;margin:16px auto;padding:0 12px}
    h1{font-size:18px;margin:8px 0 14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{padding:8px 12px;border:1px solid #1f2937;background:#111827;color:#e5e7eb;border-radius:9px;cursor:pointer;font-weight:700}
    button.green{background:#064e3b;border-color:#065f46}
    button.blue{background:#1e293b;border-color:#1e40af}
    button.red{background:#3f1d1d;border-color:#7f1d1d}
    button[disabled]{opacity:.45;cursor:not-allowed}
    .toggle{display:inline-flex;border-radius:10px;overflow:hidden;border:1px solid #1f2937}
    .toggle button{border:0;padding:7px 10px}
    .toggle .on{background:#064e3b} .toggle .off{background:#1f2937}
    .card{background:var(--card);border:1px solid #0b1220;border-radius:12px;padding:12px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.25)}
    .hint{color:var(--muted);font-size:12px}
    .bad{color:var(--err)} .ok{color:var(--ok)} .muted{color:var(--muted)}
    .console{background:#0b1020;border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,monospace;white-space:pre-wrap;max-height:220px;overflow:auto}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{background:#111827;border:1px solid #1f2937;border-radius:999px;padding:6px 10px;font-size:12px}
    canvas{display:block;width:100%;height:340px;background:#0b1220;border-radius:10px;border:1px solid #0b1220}
    .downloads{display:flex;gap:8px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üé§ Test Audio Core ‚Äî <b>Pitch (cents/notes) + Timeline (ligne m√©diane)</b></h1>

    <div class="row toolbar">
      <button id="btnInit" class="green">Activer micro</button>

      <div class="toggle">
        <button id="tgLiveOff" class="off">Moniteur live OFF</button>
        <button id="tgLiveOn" class="on">ON</button>
      </div>

      <button id="btnRec" class="blue">‚ñ∂Ô∏è D√©marrer l'enregistrement</button>
      <button id="btnStop" class="red" disabled>‚èπÔ∏è Stop</button>
      <span id="timer" class="chip">00:00</span>

      <div class="toggle">
        <button id="modeCents" class="on">Cents (justesse)</button>
        <button id="modeNotes" class="off">Absolu (notes)</button>
      </div>

      <div class="toggle">
        <button data-zoom="1" class="on">x1</button>
        <button data-zoom="2" class="off">x2</button>
        <button data-zoom="4" class="off">x4</button>
      </div>
    </div>

    <div class="card">
      <div class="hint">Astuce : la courbe ne s‚Äôaffiche que si <b>Moniteur live = ON</b> ou pendant un <b>enregistrement</b>. La <b>barre orange</b> (curseur temps) ne bouge que dans ces cas.</div>
      <div style="margin:8px 0 6px" class="muted">
        <span id="pitchRead">‚Äî</span> ‚Ä¢ <span id="refNote">R√©f√©rence : ‚Äî</span>
      </div>
      <canvas id="plot"></canvas>
      <div class="downloads">
        <button id="dlWebM" disabled>üì• T√©l√©charger WebM</button>
        <button id="dlWav" disabled>üì§ Exporter en WAV</button>
        <button id="dlMp3" disabled>üéß Exporter en MP3</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">Console</div>
      <div id="log" class="console">Syst√®me de logs pr√™t‚Ä¶</div>
    </div>
  </div>

  <script type="module">
    import AudioEngine from './src/audio/core/AudioEngine.js';
    import { Logger } from './src/logging/Logger.js';
    import MicrophoneManager from './src/audio/core/MicrophoneManager.js';
    import PitchService from './src/audio/analysis/PitchService.js';
    import TimelineRenderer from './src/plot/TimelineRenderer.js';
    import { CONFIG } from './src/config.js';

    // === UI refs ===
    const logBox = document.getElementById('log');
    const btnInit = document.getElementById('btnInit');
    const tgLiveOff = document.getElementById('tgLiveOff');
    const tgLiveOn  = document.getElementById('tgLiveOn');
    const btnRec = document.getElementById('btnRec');
    const btnStop = document.getElementById('btnStop');
    const timer = document.getElementById('timer');
    const modeCents = document.getElementById('modeCents');
    const modeNotes = document.getElementById('modeNotes');
    const plotCanvas = document.getElementById('plot');
    const dlWebM = document.getElementById('dlWebM');
    const dlWav  = document.getElementById('dlWav');
    const dlMp3  = document.getElementById('dlMp3');
    const pitchRead = document.getElementById('pitchRead');
    const refNote = document.getElementById('refNote');

    // === Logging to UI ===
    function appendLog(line){ const now=new Date().toTimeString().slice(0,8); logBox.textContent += `\n[${now}] ${line}`; logBox.scrollTop=logBox.scrollHeight; }
    Logger.setExternalSink?.((level, scope, msg, data) => {
      const d = data ? ` | ${JSON.stringify(data)}` : '';
      appendLog(`[${level}] [${scope}] ${msg}${d}`);
    });

    // === Runtime state ===
    let engine=null, mic=null, pitch=null, plot=null;
    let live=false, recording=false, t0=0, rafId=null, timerId=null;

    // === Init plot ===
    plot = new TimelineRenderer(plotCanvas, { mode:'cents', zoom:1 });
    plot.setMedianLabel('0 cents (r√©f.)');
    plot.onLayoutFixed(); // calc marges, √©vite chevauchement

    function setMode(mode){
      if(mode==='cents'){ plot.setMode('cents'); modeCents.className='on'; modeNotes.className='off'; }
      else { plot.setMode('notes'); modeCents.className='off'; modeNotes.className='on'; }
      plot.renderStatic();
    }
    setMode('cents');

    function setZoom(z){
      document.querySelectorAll('[data-zoom]').forEach(b=>b.className='off');
      const btn = document.querySelector(`[data-zoom="${z}"]`); if(btn) btn.className='on';
      plot.setZoom(Number(z));
      plot.renderStatic();
    }
    setZoom(1);

    // === Timer ===
    function startTimer(){
      stopTimer();
      timer.textContent='00:00';
      t0 = performance.now();
      timerId = setInterval(()=>{
        const s = Math.max(0, Math.floor((performance.now()-t0)/1000));
        const mm = String(Math.floor(s/60)).padStart(2,'0');
        const ss = String(s%60).padStart(2,'0');
        timer.textContent = `${mm}:${ss}`;
      }, 250);
    }
    function stopTimer(){ if(timerId){clearInterval(timerId); timerId=null;} }

    // === Engine bootstrap (user gesture) ===
    async function ensureEngineReady(){
      if(engine?.isReady?.()) return engine;
      const opts = { sampleRate: CONFIG?.audio?.sampleRate ?? 48000, latencyHint:'interactive' };
      engine = AudioEngine.getInstance ? AudioEngine.getInstance(opts) : new AudioEngine(opts);
      await engine.initialize?.();
      await engine.resume?.();
      if(!engine.getContext?.()) throw new Error('AudioContext introuvable');
      return engine;
    }

    // === Live / Record loops ===
    function loop(){
      const now = (performance.now()-t0)/1000;
      const meas = pitch?.measure();
      if(meas){
        // meas: { t, hz, noteName, cents } ; noteName peut √™tre null si non fiable
        if(plot.mode==='cents' && typeof meas.cents==='number'){
          plot.pushPoint(now, meas.cents);
          pitchRead.textContent = `${meas.noteName ?? '‚Äî'} ‚Ä¢ ${meas.hz?.toFixed(1) ?? '‚Äî'} Hz ‚Ä¢ ${(meas.cents>0?'+':'')}${Math.round(meas.cents)} c`;
        } else if(plot.mode==='notes' && typeof meas.hz==='number'){
          plot.pushNote(now, meas.hz);
          pitchRead.textContent = `${meas.noteName ?? '‚Äî'} ‚Ä¢ ${meas.hz.toFixed(1)} Hz`;
        }
        plot.setCursor(now);
        plot.renderDynamic();
      }
      if(live || recording) rafId = requestAnimationFrame(loop);
    }

    function startLive(){
      if(live) return;
      live = true;
      if(!recording){ t0 = performance.now(); plot.startIfIdle(); }
      rafId = requestAnimationFrame(loop);
    }
    function stopLive(){
      live = false;
      if(!recording && rafId){ cancelAnimationFrame(rafId); rafId=null; }
    }

    // === UI handlers ===
    btnInit.addEventListener('click', async () => {
      try{
        appendLog('[INFO] Init moteur & micro‚Ä¶');
        await ensureEngineReady(); // AudioContext running ici (geste utilisateur)
        mic = new MicrophoneManager(engine);
        const ok = await mic.requestAccess();
        if(!ok) throw new Error('Acc√®s micro refus√©');
        const stream = mic.getStream();
        pitch = new PitchService(engine, { onReadyNote:(name)=>refNote.textContent=`R√©f√©rence : ${name}` });
        await pitch.attachStream(stream);
        btnRec.disabled=false;
        appendLog('[INFO] Micro pr√™t. Moniteur live OFF par d√©faut.');
      }catch(e){
        appendLog(`[ERROR] Init: ${e?.message || e}`); 
      }
    });

    tgLiveOn.addEventListener('click', ()=>{
      if(!pitch){ appendLog('[WARN] Active d\'abord le micro.'); return; }
      tgLiveOn.className='on'; tgLiveOff.className='off';
      startLive();
    });
    tgLiveOff.addEventListener('click', ()=>{
      tgLiveOn.className='off'; tgLiveOff.className='on';
      stopLive();
    });

    btnRec.addEventListener('click', async ()=>{
      try{
        if(!pitch){ appendLog('[WARN] Active d\'abord le micro.'); return; }
        recording=true;
        btnRec.disabled=true; btnStop.disabled=false;
        plot.resetTimeline(); plot.startIfIdle();
        startTimer();
        t0 = performance.now();
        await pitch.startRecord(); // d√©marre MediaRecorder interne
        if(!live) startLive();
        appendLog('[INFO] Enregistrement en cours‚Ä¶');
      }catch(e){
        recording=false; btnRec.disabled=false; btnStop.disabled=true;
        appendLog('[ERROR] Record: '+(e?.message||e));
      }
    });

    btnStop.addEventListener('click', async ()=>{
      try{
        btnStop.disabled=true;
        await pitch?.stopRecord();
        recording=false;
        stopTimer();
        if(!live && rafId){ cancelAnimationFrame(rafId); rafId=null; }
        const { webm, wav, mp3 } = await pitch?.getExports() ?? {};
        // Active boutons si dispos
        dlWebM.disabled = !webm; dlWav.disabled = !wav; dlMp3.disabled = !mp3;
        dlWebM.onclick = ()=> webm && downloadBlob(webm.blob, webm.name);
        dlWav.onclick  = ()=> wav  && downloadBlob(wav.blob,  wav.name);
        dlMp3.onclick  = ()=> mp3  && downloadBlob(mp3.blob,  mp3.name);
        btnRec.disabled=false;
        appendLog('[INFO] Enregistrement termin√©.');
      }catch(e){
        appendLog('[ERROR] Stop: '+(e?.message||e));
      }
    });

    function downloadBlob(blob, filename){
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    // Modes
    modeCents.addEventListener('click', ()=>setMode('cents'));
    modeNotes.addEventListener('click', ()=>setMode('notes'));
    document.querySelectorAll('[data-zoom]').forEach(btn=>{
      btn.addEventListener('click', ()=> setZoom(btn.dataset.zoom));
    });
  </script>
</body>
</html>
