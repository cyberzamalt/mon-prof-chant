<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Test Audio Core</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--text:#1f2937;--muted:#6b7280;--ok:#16a34a;--warn:#d97706;--err:#dc2626;--blue:#4f46e5;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:900px;margin:24px auto;padding:16px}
    .title{font-size:24px;font-weight:800;margin:8px 0 4px}
    .subtitle{color:var(--muted);margin:0 0 20px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin:12px 0}
    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kv{border:1px solid #e5e7eb;border-radius:10px;padding:12px}
    .kv b{display:block;color:var(--muted);font-weight:600;margin-bottom:6px}
    .badge{display:inline-flex;align-items:center;gap:8px;background:#e8f6ef;color:var(--ok);border:1px solid #b7e4c7;padding:8px 12px;border-radius:10px;font-weight:600}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .b1{background:#e5e7eb;color:#111827}
    .b2{background:#111827;color:#fff}
    .b3{background:#e11d48;color:#fff}
    .b4{background:#10b981;color:#fff}
    .b1[disabled],.b2[disabled],.b3[disabled]{opacity:.45;cursor:not-allowed}
    pre{background:#0b1020;color:#dbeafe;border-radius:10px;padding:12px;max-height:320px;overflow:auto}
    .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">üé§ Test Audio Core</div>
    <p class="subtitle">Test des modules de base du syst√®me audio</p>

    <div class="card">
      <div class="badge">üîí Protocole d√©tect√© : <span id="protoTxt" style="margin-left:6px">‚Äî</span></div>
    </div>

    <div class="card">
      <div style="font-weight:800;margin-bottom:6px">‚úÖ Statut du Syst√®me</div>
      <div id="sysStatus" class="muted">En attente‚Ä¶ cliquez sur ‚ÄúInitialiser‚Äù.</div>
    </div>

    <div class="card">
      <div style="font-weight:800;margin-bottom:10px">üéõÔ∏è AudioContext</div>
      <div class="row">
        <div class="kv"><b>√âTAT</b><span id="ctxState">‚Äî</span></div>
        <div class="kv"><b>SAMPLE RATE</b><span id="ctxRate">‚Äî</span></div>
        <div class="kv"><b>BASE LATENCY</b><span id="ctxLatency">‚Äî</span></div>
        <div class="kv"><b>CURRENT TIME</b><span id="ctxTime">‚Äî</span></div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:800;margin-bottom:10px">üß≠ Navigateur</div>
      <div class="row">
        <div class="kv"><b>NAVIGATEUR</b><span id="navName">‚Äî</span></div>
        <div class="kv"><b>VERSION</b><span id="navVer">‚Äî</span></div>
        <div class="kv"><b>OS</b><span id="navOS">‚Äî</span></div>
        <div class="kv"><b>MOBILE</b><span id="navMob">‚Äî</span></div>
      </div>
    </div>

    <div class="btns">
      <button class="b4" id="btnInit">‚úÖ Initialiser</button>
      <button class="b2" id="btnMic" disabled>üé§ Tester Microphone</button>
      <button class="b3" id="btnDestroy" disabled>üß® D√©truire</button>
      <button class="b1" id="btnClear">üßπ Effacer Logs</button>
    </div>

    <div class="card">
      <div style="font-weight:800;margin-bottom:10px">Console</div>
      <pre id="logBox">Syst√®me de logs pr√™t‚Ä¶</pre>
    </div>
  </div>

  <script type="module">
    // --- Imports des modules du projet (chemins identiques √† tes logs) ---
    import AudioEngine from './src/audio/core/AudioEngine.js';
    import { Logger } from './src/logging/Logger.js';
    import MicrophoneManager from './src/audio/core/MicrophoneManager.js';
    import BrowserDetector from './src/utils/BrowserDetector.js';
    import AudioContextManager from './src/audio/core/AudioContextManager.js'; // utilis√© indirectement par AudioEngine
    import './src/audio/core/ErrorHandler.js'; // enregistre le handler global
    import { CONFIG } from './src/config.js';

    // --- Elements UI ---
    const logBox = document.getElementById('logBox');
    const btnInit = document.getElementById('btnInit');
    const btnMic = document.getElementById('btnMic');
    const btnDestroy = document.getElementById('btnDestroy');
    const btnClear = document.getElementById('btnClear');

    const protoTxt = document.getElementById('protoTxt');
    const sysStatus = document.getElementById('sysStatus');

    const ctxState = document.getElementById('ctxState');
    const ctxRate = document.getElementById('ctxRate');
    const ctxLatency = document.getElementById('ctxLatency');
    const ctxTime = document.getElementById('ctxTime');

    const navName = document.getElementById('navName');
    const navVer  = document.getElementById('navVer');
    const navOS   = document.getElementById('navOS');
    const navMob  = document.getElementById('navMob');

    // --- Helpers log vers le <pre> ---
    function addLog(line) {
      const now = new Date().toTimeString().slice(0,8);
      logBox.textContent += `\n[${now}] ${line}`;
      logBox.scrollTop = logBox.scrollHeight;
    }
    Logger.setExternalSink?.((level, scope, msg, data) => {
      const d = data ? ` | ${JSON.stringify(data)}` : '';
      addLog(`[${level}] [${scope}] ${msg}${d}`);
    });

    // --- √âtat runtime ---
    let audioEngine = null;
    let micManager  = null;
    let ctxInterval = null;

    // --- Affichages init ---
    (function showProtocolAndBrowser(){
      const https = location.protocol === 'https:' || location.hostname === 'localhost';
      protoTxt.textContent = https ? 'HTTPS (s√©curis√©)' : 'HTTP (non s√©curis√©)';
      protoTxt.style.color = https ? 'var(--ok)' : 'var(--err)';

      const b = BrowserDetector.detect();
      navName.textContent = b?.name ?? '‚Äî';
      navVer.textContent  = b?.fullVersion ?? (b?.version ?? '‚Äî');
      navOS.textContent   = b?.os ?? '‚Äî';
      navMob.textContent  = b?.mobile ? 'Oui' : 'Non';

      Logger.info('Test', 'üì± Page charg√©e');
      Logger.info('Protocol', https ? 'HTTPS d√©tect√© - Microphone accessible' : 'HTTP d√©tect√© - Activer HTTPS pour le micro');
      Logger.info('BrowserDetector', 'D√©tection du navigateur...');
      Logger.info('BrowserDetector', `${b?.name ?? '?'} ${b?.fullVersion ?? b?.version ?? ''} sur ${b?.os ?? '?'}`, b);
      const report = BrowserDetector.getCompatibilityReport?.() ?? {
        browser: b,
        features: {
          AudioContext: !!window.AudioContext || !!window.webkitAudioContext,
          getUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
          MediaRecorder: 'MediaRecorder' in window,
          AnalyserNode: !!(window.AudioContext || window.webkitAudioContext),
          localStorage: 'localStorage' in window,
          WebAudio: !!(window.AudioContext || window.webkitAudioContext),
        },
        recommendations: [],
        warnings: []
      };
      Logger.info('BrowserDetector', 'Rapport de compatibilit√© g√©n√©r√©', report);
    })();

    // --- MAJ panneau AudioContext ---
    function startContextTicker(ctx) {
      stopContextTicker();
      ctxInterval = setInterval(() => {
        try {
          ctxState.textContent   = ctx?.state ?? '‚Äî';
          ctxRate.textContent    = `${ctx?.sampleRate ?? 0} Hz`;
          ctxLatency.textContent = (ctx?.baseLatency ?? 0).toFixed ? `${(ctx.baseLatency*1000).toFixed(2)} ms` : '0,00 ms';
          ctxTime.textContent    = `${(ctx?.currentTime ?? 0).toFixed(2)} s`;
        } catch {}
      }, 250);
    }
    function stopContextTicker(){
      if (ctxInterval) { clearInterval(ctxInterval); ctxInterval = null; }
    }

    // --- Bouton: Initialiser ---
    btnInit.addEventListener('click', async () => {
      addLog('[INFO] [Test] üöÄ Initialisation de l\'AudioEngine...');
      try {
        audioEngine = new AudioEngine({ sampleRate: CONFIG?.audio?.sampleRate ?? 48000, latencyHint: 'interactive' });
        const ctx = audioEngine.getContext?.();
        if (!ctx) throw new Error('AudioContext introuvable');

        // tenter resume (doit marcher apr√®s geste user)
        if (ctx.state !== 'running') {
          await ctx.resume?.();
        }

        startContextTicker(ctx);

        sysStatus.innerHTML = '<span class="ok">Syst√®me initialis√© avec succ√®s</span><br>AudioEngine op√©rationnel. Vous pouvez maintenant tester le microphone.';
        btnMic.disabled = false;
        btnDestroy.disabled = false;
      } catch (e) {
        sysStatus.innerHTML = `<span class="err">√âchec d\'initialisation</span><br>${e?.message ?? e}`;
        addLog(`[ERROR] [Test] Init AudioEngine: ${e?.message ?? e}`);
      }
    });

    // --- Bouton: Tester Microphone ---
    btnMic.addEventListener('click', async () => {
      Logger.info('Test', 'üé§ Test du microphone...');
      try {
        if (!audioEngine) {
          addLog('[WARN] [Test] AudioEngine non initialis√©. Cliquez sur ‚ÄúInitialiser‚Äù d‚Äôabord.');
          return;
        }
        // 1) Cr√©er le manager si absent
        if (!micManager) {
          micManager = new MicrophoneManager(audioEngine /*, eventBus optionnel */);
          Logger.info('MicrophoneManager', 'MicrophoneManager cr√©√©');
        }

        // 2) Demander l‚Äôacc√®s (renvoie true/false, PAS un MediaStream)
        const ok = await micManager.requestPermission(); // alias ‚Üí requestAccess()
        if (!ok) {
          addLog('[ERROR] [Test] Acc√®s micro refus√© ou erreur (voir logs au-dessus).');
          return;
        }

        // 3) R√©cup√©rer le VRAI MediaStream depuis le manager
        const stream = micManager.getStream();
        if (!stream) {
          addLog('[ERROR] [Test] Flux micro introuvable malgr√© autorisation.');
          return;
        }

        // (Infos piste pour confirmer)
        const tracks = stream.getAudioTracks?.() ?? [];
        Logger.info('Test', 'Piste micro', { count: tracks.length, label: tracks[0]?.label || 'N/A' });

        // 4) (Optionnel) cr√©er le MediaStreamSource pour lier au graphe WebAudio
        const source = micManager.createSource();
        if (source) {
          Logger.info('Test', 'MediaStreamSource cr√©√©');
          addLog('[INFO] [Test] Micro OK ‚Üí flux ouvert & source WebAudio cr√©√©e.');
        } else {
          addLog('[WARN] [Test] Flux ouvert, mais source WebAudio non cr√©√©e (voir logs).');
        }

      } catch (e) {
        Logger.error('Test', 'Erreur pendant le test micro', { message: e?.message, name: e?.name });
        addLog(`[ERROR] [Test] ${e?.name ?? 'Error'}: ${e?.message ?? e}`);
      }
    });

    // --- Bouton: D√©truire ---
    btnDestroy.addEventListener('click', async () => {
      try {
        stopContextTicker();
        if (micManager) { micManager.destroy?.(); micManager = null; }
        if (audioEngine) {
          // si AudioEngine expose une m√©thode de close/destroy, sinon juste lib√©rer la ref
          const ctx = audioEngine.getContext?.();
          if (ctx?.state === 'running' && ctx?.close) { await ctx.close(); }
          audioEngine = null;
        }
        sysStatus.innerHTML = 'R√©initialis√©. Cliquez sur ‚ÄúInitialiser‚Äù pour recommencer.';
        btnMic.disabled = true;
        btnDestroy.disabled = true;

        ctxState.textContent = ctxRate.textContent = ctxLatency.textContent = ctxTime.textContent = '‚Äî';
        addLog('[INFO] [Test] Syst√®me d√©truit.');
      } catch (e) {
        addLog(`[ERROR] [Test] Destroy: ${e?.message ?? e}`);
      }
    });

    // --- Bouton: Effacer logs ---
    btnClear.addEventListener('click', () => {
      logBox.textContent = 'Syst√®me de logs pr√™t‚Ä¶';
    });
  </script>
</body>
</html>
