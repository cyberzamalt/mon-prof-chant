<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Audio Core - Diagnostic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-bottom: 10px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        #logs {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .log-line {
            margin-bottom: 5px;
            padding: 3px 0;
        }
        .log-info { color: #00ff00; }
        .log-success { color: #00ff88; font-weight: bold; }
        .log-error { color: #ff4444; font-weight: bold; }
        .log-warn { color: #ffaa00; }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }
        .status-ok { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Test Audio Core - Diagnostic Complet</h1>
        
        <!-- Section 1: Info Protocole -->
        <div class="section">
            <h2>üîí Protocole D√©tect√©</h2>
            <div id="protocol-info"></div>
        </div>

        <!-- Section 2: Tests -->
        <div class="section">
            <h2>üß™ Tests Disponibles</h2>
            <button onclick="testAudioEngine()">1Ô∏è‚É£ Initialiser AudioEngine</button>
            <button onclick="testMicrophone()">2Ô∏è‚É£ D√©marrer Microphone</button>
            <button onclick="testAudioPlayback()">3Ô∏è‚É£ Tester Lecture Audio (Bip)</button>
            <button onclick="listAudioDevices()">4Ô∏è‚É£ Lister Devices Audio</button>
            <button onclick="clearLogs()">üóëÔ∏è Effacer Logs</button>
        </div>

        <!-- Section 3: Logs -->
        <div class="section">
            <h2>üìã Logs en Direct</h2>
            <div id="logs"></div>
        </div>
    </div>

    <script type="module">
        // Import depuis les vrais fichiers
        import { AudioEngine } from './src/audio/core/AudioEngine.js';
        import { MicrophoneManager } from './src/audio/core/MicrophoneManager.js';
        import { AudioBus } from './src/audio/core/AudioBus.js';

        // Variables globales pour les tests
        let audioEngine = null;
        let micManager = null;
        let eventBus = null;

        // Fonction de log avec couleurs
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            
            let icon = '';
            if (type === 'success') icon = '‚úÖ';
            else if (type === 'error') icon = '‚ùå';
            else if (type === 'warn') icon = '‚ö†Ô∏è';
            else icon = 'üîß';
            
            line.textContent = `[${timestamp}] ${icon} ${message}`;
            logsDiv.appendChild(line);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // V√©rifier protocole au chargement
        function checkProtocol() {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const infoDiv = document.getElementById('protocol-info');
            
            if (protocol === 'https:') {
                infoDiv.innerHTML = `
                    <div class="status status-ok">
                        ‚úÖ HTTPS D√©tect√© - Microphone autoris√©
                    </div>
                    <p style="margin-top:10px; color:#666;">
                        Le navigateur autorisera l'acc√®s au microphone.
                    </p>
                `;
                log('‚úÖ Protocole HTTPS - OK pour microphone', 'success');
            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                infoDiv.innerHTML = `
                    <div class="status status-ok">
                        ‚úÖ Localhost D√©tect√© - Microphone autoris√©
                    </div>
                    <p style="margin-top:10px; color:#666;">
                        Le navigateur autorisera l'acc√®s au microphone en d√©veloppement local.
                    </p>
                `;
                log('‚úÖ Localhost d√©tect√© - OK pour microphone', 'success');
            } else {
                infoDiv.innerHTML = `
                    <div class="status status-error">
                        ‚ùå HTTP D√©tect√© - Microphone BLOQU√â
                    </div>
                    <p style="margin-top:10px; color:#721c24; font-weight:bold;">
                        Le navigateur REFUSERA l'acc√®s au microphone sur ${protocol}//${hostname}
                    </p>
                    <p style="margin-top:10px; color:#856404;">
                        <strong>Solutions :</strong><br>
                        1. Testez en local : <code>http://localhost:8000/test-audio-core.html</code><br>
                        2. H√©bergez avec HTTPS (GitHub Pages, Netlify, Vercel)
                    </p>
                `;
                log('‚ùå HTTP d√©tect√© - Microphone sera REFUS√â', 'error');
                log('‚ö†Ô∏è Free.fr ne supporte pas HTTPS', 'warn');
            }
        }

        // Test 1: AudioEngine
        window.testAudioEngine = async function() {
            try {
                log('üîß Initialisation AudioEngine...', 'info');
                audioEngine = AudioEngine.getInstance();
                await audioEngine.init();
                
                const ctx = audioEngine.getContext();
                log(`‚úÖ AudioEngine initialis√© !`, 'success');
                log(`Sample Rate: ${ctx.sampleRate} Hz`, 'info');
                log(`Context State: ${ctx.state}`, 'info');
                
                // Initialiser EventBus
                eventBus = new AudioBus(ctx);
                log('‚úÖ EventBus cr√©√©', 'success');
                
            } catch (error) {
                log(`‚ùå Erreur AudioEngine: ${error.message}`, 'error');
                console.error(error);
            }
        };

        // Test 2: Microphone
        window.testMicrophone = async function() {
            try {
                if (!audioEngine) {
                    log('‚ö†Ô∏è AudioEngine pas initialis√© - Lancement auto...', 'warn');
                    await window.testAudioEngine();
                }
                
                log('üé§ Demande d\'acc√®s au microphone...', 'info');
                
                micManager = new MicrophoneManager(audioEngine, eventBus);
                await micManager.init();
                
                log('‚úÖ Microphone autoris√© et initialis√© !', 'success');
                
                micManager.start();
                log('‚úÖ Microphone d√©marr√© - Capture en cours', 'success');
                
            } catch (error) {
                if (error.name === 'NotAllowedError') {
                    log('‚ùå Acc√®s microphone refus√© par l\'utilisateur', 'error');
                } else if (error.name === 'NotFoundError') {
                    log('‚ùå Aucun microphone d√©tect√©', 'error');
                } else if (error.name === 'NotSupportedError') {
                    log('‚ùå Microphone non support√© en HTTP (hors localhost)', 'error');
                } else {
                    log(`‚ùå Erreur microphone: ${error.message}`, 'error');
                }
                console.error(error);
            }
        };

        // Test 3: Audio Playback
        window.testAudioPlayback = async function() {
            try {
                if (!audioEngine) {
                    log('‚ö†Ô∏è AudioEngine pas initialis√© - Lancement auto...', 'warn');
                    await window.testAudioEngine();
                }
                
                log('üîä Test audio: lecture d\'un bip...', 'info');
                
                const ctx = audioEngine.getContext();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.frequency.value = 440; // La (A4)
                gainNode.gain.value = 0.3;
                
                oscillator.start();
                setTimeout(() => {
                    oscillator.stop();
                    log('‚úÖ Bip jou√© (La 440 Hz)', 'success');
                }, 500);
                
            } catch (error) {
                log(`‚ùå Erreur playback: ${error.message}`, 'error');
                console.error(error);
            }
        };

        // Test 4: List Audio Devices
        window.listAudioDevices = async function() {
            try {
                log('üìã Liste des devices audio...', 'info');
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(d => d.kind === 'audioinput');
                
                log(`Trouv√© ${audioInputs.length} device(s)`, 'info');
                
                if (audioInputs.length === 0) {
                    log('‚ö†Ô∏è Aucun microphone d√©tect√©', 'warn');
                    log('Possible si permission non accord√©e', 'warn');
                } else {
                    audioInputs.forEach((device, index) => {
                        const label = device.label || `Microphone ${index + 1}`;
                        log(`  ${index + 1}. ${label}`, 'info');
                    });
                }
                
            } catch (error) {
                log(`‚ùå Erreur √©num√©ration: ${error.message}`, 'error');
                console.error(error);
            }
        };

        // Clear logs
        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '';
            log('üóëÔ∏è Logs effac√©s', 'info');
        };

        // Au chargement
        window.addEventListener('DOMContentLoaded', () => {
            checkProtocol();
            log('‚ú® Page charg√©e - Pr√™t pour les tests', 'success');
        });
    </script>
</body>
</html>