<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mon Professeur de Chant ‚Äì v2</title>
  <style>
    :root{
      --bg:#0b0f16; --panel:#111726; --card:#121a2b; --grid:#1a2742;
      --text:#e6e8ee; --muted:#9aa3b2; --ok:#166534; --danger:#d33; --accent:#3b82f6;
      --bd:#263347; --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    *{box-sizing:border-box} html,body{height:100%;margin:0}
    body{background:var(--bg); color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:18px 20px; text-align:center; border-bottom:1px solid var(--bd); background:var(--panel)}
    h1{margin:0; font-size:22px; color:#37d770}
    main{max-width:1200px;margin:24px auto; padding:0 16px}
    .bar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; background:var(--panel); border:1px solid var(--bd); padding:12px; border-radius:12px}
    .btn{border:1px solid transparent; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .b-ok{background:var(--ok); color:#fff}
    .b-stop{background:var(--danger); color:#fff}
    .b-sec{background:#21304a; color:#dfe7f6; border-color:#2a3a58}
    .b-ghost{background:transparent; color:#c9d4e8; border-color:#3a4a66}
    .grid{display:grid; gap:18px}
    @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
    .panel{background:var(--panel); border:1px solid var(--bd); border-radius:14px; padding:14px}
    .ph{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
    .ph h3{margin:0; font-size:15px}
    .status{font-size:12px; color:#9fb0c9}
    canvas{display:block; width:100%; height:360px; background:#05080f; border:1px solid var(--bd); border-radius:10px}
    .info{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:10px}
    .infobox{background:#0d1422; border:1px solid var(--bd); border-radius:8px; padding:8px; text-align:center}
    .lbl{font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.04em}
    .val{font-family:var(--mono); font-weight:700}
    .note{margin-top:6px; color:var(--muted); font-size:12px}
    .toast{position:fixed; right:16px; top:16px; background:#0d1422; border:1px solid var(--bd); padding:12px 14px; border-radius:10px; display:none}
    .toast.show{display:block}
  </style>
</head>
<body>
  <header>
    <h1>üé§ Mon Professeur de Chant</h1>
    <div class="note">Analyse vocale en temps r√©el ‚Ä¢ v2 clean</div>
  </header>

  <main>
    <div class="bar">
      <button id="btnStart" class="btn b-ok" onclick="handleStart()">‚ñ∂Ô∏è D√©marrer</button>
      <button id="btnStop" class="btn b-stop" onclick="handleStop()" disabled>‚èπÔ∏è Arr√™ter</button>
      <button id="btnRec" class="btn b-sec" onclick="handleRecord()" disabled>‚è∫Ô∏è Enregistrer</button>
      <button class="btn b-ghost" onclick="handleClear()">üóëÔ∏è Effacer</button>
      <span class="note" id="statusMsg">Pr√™t.</span>
    </div>

    <div class="grid">
      <section class="panel" id="panel-recording">
        <div class="ph">
          <h3>Enregistrement Live</h3>
          <button class="btn b-ghost" id="dlLive" onclick="downloadLive()" disabled>‚¨áÔ∏è T√©l√©charger MP3</button>
        </div>
        <canvas id="canvas-recording" width="1200" height="360"></canvas>
        <div class="info">
          <div class="infobox"><div class="lbl">Fr√©quence</div><div class="val" id="freq-recording">‚Äî</div></div>
          <div class="infobox"><div class="lbl">Note</div><div class="val" id="note-recording">‚Äî</div></div>
          <div class="infobox"><div class="lbl">Cents</div><div class="val" id="cents-recording">‚Äî</div></div>
        </div>
      </section>

      <section class="panel" id="panel-reference">
        <div class="ph">
          <h3>R√©f√©rence Audio</h3>
          <button class="btn b-ghost" id="dlRef" onclick="downloadRef()" disabled>‚¨áÔ∏è T√©l√©charger MP3</button>
        </div>
        <canvas id="canvas-reference" width="1200" height="360"></canvas>
        <div class="info">
          <div class="infobox"><div class="lbl">Fr√©quence</div><div class="val" id="freq-reference">‚Äî</div></div>
          <div class="infobox"><div class="lbl">Note</div><div class="val" id="note-reference">‚Äî</div></div>
          <div class="infobox"><div class="lbl">Cents</div><div class="val" id="cents-reference">‚Äî</div></div>
        </div>
      </section>
    </div>
  </main>

  <div id="toast" class="toast"></div>

  <!-- D√©pendances externes requises -->
  <script src="src/vendor/yin-detector.js"></script>
  <script src="src/utils/pitch-smoothing.js"></script>
  <script src="src/vendor/lame.min.js"></script>

  <!-- App v2 -->
  <script type="module">
    import app from './src/app.js';
    window.appInstance = app;

    const T = (msg, type='info')=>{
      const el = document.getElementById('toast');
      el.className = 'toast show';
      el.textContent = msg;
      setTimeout(()=>el.classList.remove('show'), 2200);
    };

    window.handleStart = async ()=>{
      try{
        await app.start();
        document.getElementById('btnStart').disabled = true;
        document.getElementById('btnStop').disabled = false;
        document.getElementById('btnRec').disabled = false;
        T('Micro d√©marr√©.'); 
      }catch(e){ T('Erreur: '+(e?.message||e), 'err'); }
    };

    window.handleStop = ()=>{
      app.stop();
      document.getElementById('btnStart').disabled = false;
      document.getElementById('btnStop').disabled = true;
      document.getElementById('btnRec').disabled = true;
      T('Arr√™t√©.');
    };

    window.handleRecord = async ()=>{
      try{
        const started = await app.toggleRecord(); // start/stop
        document.getElementById('btnRec').textContent = started ? '‚èπÔ∏è Arr√™ter Enreg.' : '‚è∫Ô∏è Enregistrer';
        document.getElementById('dlLive').disabled = !app.hasRecording();
        T(started?'Enregistrement d√©marr√©.':'Enregistrement arr√™t√©.');
      }catch(e){ T('Erreur: '+(e?.message||e), 'err'); }
    };

    window.handleClear = ()=>{
      app.clearPanels();
      T('Trac√©s effac√©s.');
    };

    window.downloadLive = async ()=>{
      const file = await app.getLastMp3('live');
      if(!file) return T('Aucun enregistrement.');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(file.blob);
      a.download = file.name;
      a.click();
      URL.revokeObjectURL(a.href);
      T('MP3 t√©l√©charg√©.');
    };

    window.downloadRef = async ()=>{
      const file = await app.getLastMp3('ref');
      if(!file) return T('Aucune r√©f√©rence.');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(file.blob);
      a.download = file.name;
      a.click();
      URL.revokeObjectURL(a.href);
      T('MP3 r√©f√©rence t√©l√©charg√©.');
    };
  </script>
</body>
</html>
