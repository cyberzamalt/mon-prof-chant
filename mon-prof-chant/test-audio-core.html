<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Test Audio Core ‚Äî Pitch + Timeline (ligne m√©diane)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f17;--card:#0f1522;--ink:#e5eefc;--muted:#8aa2c0;
      --green:#10b981;--red:#ef4444;--amber:#f59e0b;--blue:#3b82f6;--axis:#2b3344;
      --line:#7dd3fc;--median:#22c55e;--cursor:#f59e0b;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:1px solid #30405a;background:#192030;color:var(--ink);padding:9px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .btn.ok{background:var(--green);border-color:var(--green);color:#062712}
    .btn.dng{background:var(--red);border-color:var(--red)}
    .btn.alt{background:#1d2435}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #314158;background:#182034;color:var(--muted);font-weight:700}
    .panel{background:var(--card);border:1px solid #1b2435;border-radius:14px;padding:14px;margin:10px 0}
    h1{margin:0 0 8px;font-size:20px}
    canvas{width:100%;height:360px;display:block;background:#0c1320;border-radius:12px;border:1px solid #1b2435}
    .gridnote{font-size:12px;color:var(--muted)}
    .sp{flex:1}
    .legend{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px;margin-top:6px}
    .dot{width:10px;height:3px;border-radius:2px;display:inline-block;background:var(--line)}
    .dot.median{background:var(--median)}
    .dot.cursor{background:var(--cursor)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üéöÔ∏è Test Audio Core ‚Äî Pitch (cents/notes) + Timeline (ligne m√©diane)</h1>

    <div class="panel">
      <div class="row">
        <button id="btnMic" class="btn ok">Activer micro</button>
        <div class="row" style="align-items:center;gap:6px">
          <span class="chip">Moniteur live</span>
          <button id="monOFF" class="btn alt">OFF</button>
          <button id="monON"  class="btn alt">ON</button>
        </div>
        <div class="sp"></div>
        <button id="btnRec" class="btn">‚ñ∂Ô∏è D√©marrer l‚Äôenregistrement</button>
        <button id="btnStop" class="btn dng" disabled>‚èπ Stop</button>
        <span id="timer" class="chip">00:00</span>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn alt" data-zoom="1">x1</button>
        <button class="btn alt" data-zoom="2">x2</button>
        <button class="btn alt" data-zoom="4">x4</button>
        <div class="sp"></div>
        <button id="modeCents" class="btn alt">Cents (justesse)</button>
        <button id="modeNotes" class="btn alt">Absolu (notes)</button>
      </div>
    </div>

    <div class="panel">
      <canvas id="pitchCanvas" width="1200" height="360"></canvas>
      <div class="legend">
        <span class="dot"></span>Courbe de pitch (continu)
        <span class="dot median"></span>Ligne m√©diane (0 cent / note de r√©f√©rence)
        <span class="dot cursor"></span>Curseur temps (enregistrement)
        <span class="sp"></span>
        <span class="gridnote">Astuce : la courbe n‚Äôappara√Æt qu‚Äôen <b>Moniteur live ON</b> ou pendant un <b>enregistrement</b>.</span>
      </div>
    </div>

    <div class="panel">
      <div class="row">
        <button id="btnDLWebm" class="btn alt">‚¨áÔ∏è T√©l√©charger WebM</button>
        <button id="btnDLWav"  class="btn alt">üéß Exporter en WAV</button>
        <button id="btnDLMP3"  class="btn alt">üíΩ Exporter en MP3</button>
      </div>
      <pre id="log" class="panel" style="margin:12px 0 0;max-height:180px;overflow:auto;background:#0b0f17;border:1px solid #1b2435"></pre>
    </div>
  </div>

  <!-- Libs (Pitchy pour la d√©tection) -->
  <script src="https://cdn.jsdelivr.net/npm/pitchy@4.1.0/dist/pitchy.min.js"></script>

  <!-- Code app -->
  <script type="module">
    import AudioEngine from './src/audio/core/AudioEngine.js';
    import MicrophoneManager from './src/audio/core/MicrophoneManager.js';
    import PitchDetector from './src/audio/analysis/PitchDetector.js';
    import PitchCurveDisplay from './src/audio/visualization/PitchCurveDisplay.js';

    // ‚Äî‚Äî‚Äî util UI
    const $ = s => document.querySelector(s);
    const logBox = $('#log');
    const addLog = m => { const t = new Date().toTimeString().slice(0,5); logBox.textContent += `[${t}] ${m}\n`; logBox.scrollTop = logBox.scrollHeight; };

    // ‚Äî‚Äî‚Äî UI refs
    const btnMic  = $('#btnMic');
    const monOFF  = $('#monOFF');
    const monON   = $('#monON');
    const btnRec  = $('#btnRec');
    const btnStop = $('#btnStop');
    const timerEl = $('#timer');
    const btnDLWebm = $('#btnDLWebm');
    const btnDLWav  = $('#btnDLWav');
    const btnDLMP3  = $('#btnDLMP3');
    const zoomBtns  = [...document.querySelectorAll('[data-zoom]')];
    const modeCents = $('#modeCents');
    const modeNotes = $('#modeNotes');

    // ‚Äî‚Äî‚Äî modules
    let engine, mic, detector, display;
    let source = null;
    let recording = false;
    let monitorLive = false;
    let t0 = 0;
    let recTimer = null;
    let recordedBlob = null;

    // ‚Äî‚Äî‚Äî display
    display = new PitchCurveDisplay(document.getElementById('pitchCanvas'), {
      mode: 'cents',      // 'cents' | 'notes'
      yZoom: 1,           // 1/2/4
      showCursor: false,
    });

    // ‚Äî‚Äî‚Äî boutons zoom & modes
    zoomBtns.forEach(b=>{
      b.addEventListener('click', ()=>{
        display.setZoom(parseInt(b.dataset.zoom,10));
      });
    });
    modeCents.addEventListener('click', ()=>display.setMode('cents'));
    modeNotes.addEventListener('click', ()=>display.setMode('notes'));

    // ‚Äî‚Äî‚Äî minuterie
    function startTimer(){
      stopTimer();
      recTimer = setInterval(()=>{
        const s = Math.max(0, Math.floor(engine.currentTime() - t0));
        const mm = String(Math.floor(s/60)).padStart(2,'0');
        const ss = String(s%60).padStart(2,'0');
        timerEl.textContent = `${mm}:${ss}`;
      }, 200);
    }
    function stopTimer(){
      if(recTimer) { clearInterval(recTimer); recTimer=null; }
    }

    // ‚Äî‚Äî‚Äî init Audio (sur geste utilisateur)
    async function ensureAudioReady() {
      if (!engine) engine = new AudioEngine();
      if (!engine.isReady()) {
        await engine.init(); // cr√©e AudioContext suite au clic
        addLog('[INFO] AudioEngine pr√™t');
      }
    }

    // ‚Äî‚Äî‚Äî Micro
    btnMic.addEventListener('click', async ()=>{
      try{
        await ensureAudioReady();
        if (!mic) mic = new MicrophoneManager(engine);
        await mic.open();
        source = mic.createSource();
        addLog('[INFO] Micro activ√©');
        btnMic.disabled = true;
      }catch(e){ addLog(`[ERROR] Micro: ${e.message||e}`); }
    });

    // ‚Äî‚Äî‚Äî Moniteur live
    function setMonitor(on){
      monitorLive = !!on;
      monON.classList.toggle('ok', monitorLive);
      monOFF.classList.toggle('dng', !monitorLive);
      display.setLive(monitorLive);
      addLog(`[INFO] Moniteur live ${monitorLive?'ON':'OFF'}`);
    }
    monOFF.addEventListener('click', ()=>setMonitor(false));
    monON .addEventListener('click', ()=>setMonitor(true));
    setMonitor(false); // par d√©faut OFF

    // ‚Äî‚Äî‚Äî D√©tection (branch√©e uniquement quand il faut)
    function attachDetector(){
      if (detector || !source) return;
      detector = new PitchDetector(engine, { onPitch });
      detector.connect(source);
    }
    function detachDetector(){
      if (detector){ detector.destroy(); detector=null; }
    }
    function onPitch(evt){
      // Ne tracer que si live ON ou si on enregistre
      if (!monitorLive && !recording) return;
      display.addPoint(evt.timeSec, evt.value, evt.meta);
    }

    // ‚Äî‚Äî‚Äî Enregistrement
    btnRec.addEventListener('click', async ()=>{
      try{
        await ensureAudioReady();
        if (!mic || !mic.isOpen()) { addLog('[WARN] Active d‚Äôabord le micro.'); return; }
        attachDetector();
        // reset timeline
        display.reset(engine.currentTime());
        t0 = engine.currentTime();
        recording = true;
        display.setCursor(true);
        startTimer();
        addLog('[INFO] Enregistrement en cours‚Ä¶');

        // lancer MediaRecorder via mic
        await mic.startRecording();
        btnRec.disabled = true; btnStop.disabled = false;
      }catch(e){ addLog(`[ERROR] Rec: ${e.message||e}`); }
    });

    btnStop.addEventListener('click', async ()=>{
      try{
        if (!recording) return;
        const blob = await mic.stopRecording();
        recordedBlob = blob;
        recording = false;
        display.setCursor(false);
        stopTimer();
        btnRec.disabled = false; btnStop.disabled = true;
        addLog('[INFO] Enregistrement termin√©.');
      }catch(e){ addLog(`[ERROR] Stop: ${e.message||e}`); }
    });

    // ‚Äî‚Äî‚Äî Exports
    btnDLWebm.addEventListener('click', ()=>{
      if (!recordedBlob){ addLog('[WARN] Pas d‚Äôenregistrement.'); return; }
      downloadBlob(recordedBlob, 'prise.webm');
    });
    btnDLWav.addEventListener('click', async ()=>{
      if (!recordedBlob){ addLog('[WARN] Pas d‚Äôenregistrement.'); return; }
      const wav = await mic.exportWav();
      downloadBlob(wav, 'prise.wav');
    });
    btnDLMP3.addEventListener('click', async ()=>{
      if (!recordedBlob){ addLog('[WARN] Pas d‚Äôenregistrement.'); return; }
      const mp3 = await mic.exportMp3();
      downloadBlob(mp3, 'prise.mp3');
    });

    function downloadBlob(blob, filename){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
    }

    addLog('Syst√®me de logs pr√™t.');
  </script>
</body>
</html>
