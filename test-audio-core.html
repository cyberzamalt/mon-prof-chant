<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Test Audio Core ‚Äî Pitch Detection + Recording</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --bg:#0b1220;--panel:#0e1729;--card:#111a2e;--grid:#1a2642;--text:#e5e7eb;--muted:#9ca3af;
  --ok:#10b981;--err:#ef4444;--blue:#3b82f6;--violet:#a78bfa;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:1400px;margin:20px auto;padding:0 16px}
.h1{font-weight:800;font-size:20px;margin:0 0 16px}
.h2{font-weight:700;font-size:14px;margin:0 0 8px}
.bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
.btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #1f2a44;background:var(--card);color:var(--text);border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:600;font-size:13px;transition:.2s}
.btn:hover:not([disabled]){background:#16213a;border-color:#2a3a54}
.btn[disabled]{opacity:.4;cursor:not-allowed}
.seg{display:inline-flex;border:1px solid #22304f;background:var(--card);border-radius:8px;overflow:hidden}
.seg button{padding:8px 12px;border:0;background:transparent;color:var(--text);cursor:pointer;font-size:13px;font-weight:600}
.seg .active{background:#16213a;color:#22c55e}
.timer{padding:8px 12px;border:1px solid #22304f;border-radius:8px;background:var(--card);min-width:60px;text-align:center;font-weight:600;font-family:monospace}
.cols{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
@media (max-width:1024px){.cols{grid-template-columns:1fr}}
.panel{background:var(--panel);border:1px solid #1f2a44;border-radius:12px;padding:16px}
.canvasWrap{border:1px solid #1f2a44;border-radius:8px;padding:4px;background:#0b1324;margin:8px 0;position:relative}
canvas{display:block;width:100%;height:auto;background:#0b1324}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.log{background:#0b1020;border:1px solid #1f2a44;border-radius:8px;padding:12px;color:#dbeafe;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;max-height:250px;overflow-y:auto;white-space:pre-wrap;word-break:break-word}
.badge{display:inline-flex;gap:6px;align-items:center;border:1px solid #22304f;background:#0b1220;padding:4px 8px;border-radius:6px;font-size:12px}
.badge.ok{color:#bbf7d0;border-color:#206a44;background:#052216}
.badge.warn{color:#fde68a;border-color:#6b4d11;background:#261a06}
.hint{color:var(--muted);font-size:12px;margin:6px 0 8px}
.right{margin-left:auto}
input[type="file"]{padding:8px 12px;border:1px solid #22304f;border-radius:8px;background:#0f172a;color:var(--text);font-size:13px}
.metrics{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;font-size:12px}
.metric{background:#0b1220;border:1px solid #22304f;border-radius:6px;padding:6px 10px}
.debugInfo{background:#0b1020;border:1px solid #22304f;border-radius:6px;padding:6px 10px;font-size:11px;color:#cbd5e1;margin-top:8px}
</style>
</head>
<body>

<!-- TONE.JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<!-- YIN (d√©tection brute) -->
<script src="./src/vendor/yin-detector.js"></script>
<!-- LISSAGE -->
<script src="./src/utils/pitch-smoothing.js"></script>

<div class="wrap">
  <div class="h1">üéµ Test Audio Core ‚Äî Enregistrement + D√©tection Pitch (LISS√âE)</div>

  <div class="bar">
    <button id="btnMic" class="btn">üé§ Activer micro</button>

    <div class="seg">
      <button id="btnRecStart" class="btn">‚ñ∂ Enregistrer</button>
      <button id="btnRecStop" class="btn" disabled>‚èπ Stop</button>
    </div>

    <div class="timer" id="timerRec">00:00</div>

    <div class="seg">
      <button id="btnMonOff" class="btn active">Moniteur OFF</button>
      <button id="btnMonOn" class="btn">Moniteur ON</button>
    </div>

    <span class="right badge warn" id="pitchyStatus">D√©tecteur: chargement...</span>
  </div>

  <div class="cols">
    <div class="panel">
      <p class="h2">üéôÔ∏è Ta prise (micro)</p>
      <div class="hint">Courbe bleue = ton pitch liss√©. Ligne verte = 0 cent (440 Hz). Fen√™tre visible : <b>30 s</b>.</div>
      <div class="canvasWrap">
        <canvas id="canvasRec" width="600" height="320"></canvas>
      </div>
      <div class="debugInfo" id="debugRec">D√©tections brutes: 0 | Points liss√©s: 0</div>
      <div class="controls">
        <button id="btnDownWebM" class="btn">‚¨áÔ∏è WebM</button>
        <button id="btnDownWAV" class="btn">üéß WAV</button>
        <button id="btnDownMP3" class="btn">üéµ MP3</button>
        <button id="btnClearRec" class="btn">üóëÔ∏è Effacer</button>
        <input type="file" id="fileUploadRec" accept="audio/*" class="btn" style="border:1px solid #22304f;padding:8px 12px;cursor:pointer" />
      </div>
    </div>

    <div class="panel">
      <p class="h2">üéº R√©f√©rence (comparaison)</p>
      <div class="hint">Charge un MP3/WAV local pour comparer ta courbe.</div>
      <div class="canvasWrap">
        <canvas id="canvasRef" width="600" height="320"></canvas>
      </div>
      <div class="debugInfo" id="debugRef">D√©tections brutes: 0 | Points liss√©s: 0</div>
      <div class="controls">
        <input type="file" id="fileUploadRef" accept="audio/*" class="btn" style="border:1px solid #22304f;padding:8px 12px;cursor:pointer" />
        <button id="btnClearRef" class="btn">üóëÔ∏è Effacer</button>
      </div>
      <div class="metrics" id="metricsRef">
        <div class="metric">√âcart moy: <b id="mAvg">‚Äî</b></div>
        <div class="metric">√âcart max: <b id="mMax">‚Äî</b></div>
        <div class="metric">% juste: <b id="mInTune">‚Äî</b></div>
      </div>
    </div>
  </div>

  <div class="h1">üìã Logs</div>
  <div id="logBox" class="log">D√©marrage...</div>
</div>

<script src="./src/utils/wav-export.js"></script>
<script src="./src/utils/mp3-export.js"></script>

<script>
/* ==================== LOGGER ==================== */
const logBox = document.getElementById('logBox');
const log = (level, msg) => {
  const now = new Date();
  const h = String(now.getHours()).padStart(2, '0');
  const m = String(now.getMinutes()).padStart(2, '0');
  const s = String(now.getSeconds()).padStart(2, '0');
  logBox.textContent += `[${h}:${m}:${s}] [${level}] ${msg}\n`;
  logBox.scrollTop = logBox.scrollHeight;
};

/* ==================== CONSTANTES ==================== */
const VISIBLE_WINDOW = 30;          // secondes visibles (fen√™tre glissante)
const LEFT_PAD = 60, RIGHT_PAD = 20, TOP_PAD = 24, BOTTOM_PAD = 28;

const Y_RANGE_CENTS = 200;          // ¬±200c visibles
const CLAMP_SOFT = 300;             // clamp doux ¬±300c (anti-√©cr√™tage)
const MIN_HZ = 60, MAX_HZ = 1200;   // garde-fou vocal

/* ==================== √âTAT ==================== */
let audioCtx=null, analyser=null, micStream=null, mediaRecorder=null;
let chunks=[], lastBlob=null;
let detector=null, smoother=null;
let recordedPitch=[];               // {t, hz, cents, x, y}
let recordDetectionCount=0, recordDetectionRawCount=0;
let recStart=0, timerInterval=null, rafId=null, monitorOn=false;

let refData={ pitch:[], duration:0 }, refDetectionCount=0;

const canvasRec=document.getElementById('canvasRec'), ctxRec=canvasRec.getContext('2d');
const canvasRef=document.getElementById('canvasRef'), ctxRef=canvasRef.getContext('2d');

const btnMic=document.getElementById('btnMic');
const btnRecStart=document.getElementById('btnRecStart');
const btnRecStop=document.getElementById('btnRecStop');
const timerRec=document.getElementById('timerRec');
const btnMonOff=document.getElementById('btnMonOff');
const btnMonOn=document.getElementById('btnMonOn');
const pitchyStatus=document.getElementById('pitchyStatus');
const debugRec=document.getElementById('debugRec');
const debugRef=document.getElementById('debugRef');
const mAvg=document.getElementById('mAvg');
const mMax=document.getElementById('mMax');
const mInTune=document.getElementById('mInTune');
const fileUploadRec=document.getElementById('fileUploadRec');
const fileUploadRef=document.getElementById('fileUploadRef');
const btnDownWebM=document.getElementById('btnDownWebM');
const btnDownWAV=document.getElementById('btnDownWAV');
const btnDownMP3=document.getElementById('btnDownMP3');
const btnClearRec=document.getElementById('btnClearRec');
const btnClearRef=document.getElementById('btnClearRef');

/* ==================== BACKGROUNDS CACH√âS (perf) ==================== */
const bgRec = document.createElement('canvas');
const bgRecCtx = bgRec.getContext('2d');
const bgRef = document.createElement('canvas');
const bgRefCtx = bgRef.getContext('2d');

function syncBackbuffers(){
  [ [bgRec,bgRecCtx,canvasRec], [bgRef,bgRefCtx,canvasRef] ].forEach(([b,bc,src])=>{
    b.width = src.width; b.height = src.height;
  });
  buildRecBackground();
  buildRefBackground();
}

/* ==================== MAPPINGS ==================== */
function softClampCents(c){
  // clamp doux via tanh pour √©viter l‚Äô√©cr√™tage brutal
  return CLAMP_SOFT * Math.tanh(c / CLAMP_SOFT);
}
function mapCentsToY(cents, height){
  const c = softClampCents(Math.max(-CLAMP_SOFT, Math.min(CLAMP_SOFT, cents)));
  const usable = height - TOP_PAD - BOTTOM_PAD;
  const pxPerCent = usable / (2*Y_RANGE_CENTS);
  const mid = TOP_PAD + usable/2;
  return mid - c*pxPerCent;
}
function hzToCents(hz, ref=440){ return (hz>0) ? 1200*Math.log2(hz/ref) : 0; }
function fmtTime(sec){ const mm=String(Math.floor(sec/60)).padStart(2,'0'); const ss=String(Math.floor(sec%60)).padStart(2,'0'); return `${mm}:${ss}`; }

/* ==================== AUDIO ==================== */
async function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    log('INFO','AudioContext cr√©√©');
  }
  if(audioCtx.state==='suspended'){ await audioCtx.resume(); log('INFO','AudioContext repris'); }
}

async function activateMic(){
  try{
    await ensureAudio();
    if(!micStream){
      micStream = await navigator.mediaDevices.getUserMedia({audio:true});
      log('INFO','Microphone autoris√©');
    }
    if(!analyser){
      const src = audioCtx.createMediaStreamSource(micStream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      src.connect(analyser);
      log('INFO','Analyser connect√©');
    }
    btnMic.disabled = true;
    btnRecStart.disabled = false;
    if(!detector) initDetector();
    if(!smoother) initSmoother();
  }catch(err){ log('ERROR','Mic: '+err.message); }
}

/* ==================== YIN + LISSAGE ==================== */
function initDetector(){
  try{
    if(typeof YinDetector==='undefined') throw new Error('YinDetector non disponible');
    detector = new YinDetector(audioCtx.sampleRate, 2048);
    detector.threshold = 0.05; // plus sensible
    pitchyStatus.textContent='D√©tecteur: OK'; pitchyStatus.className='badge ok';
    log('INFO','D√©tecteur pitch (YinDetector) initialis√© - Seuil: 0.05');
    return true;
  }catch(err){
    pitchyStatus.textContent='D√©tecteur: ERREUR'; pitchyStatus.className='badge err';
    log('ERROR','initDetector: '+err.message);
    return false;
  }
}
function initSmoother(){
  try{
    if(typeof PitchSmoother==='undefined'){ log('WARN','PitchSmoother non dispo'); return false; }
    smoother = new PitchSmoother({
      medianWindowSize:5,
      smoothingFactor:0.75,
      maxPitchJump:250,
      minConfidence:0.2
    });
    log('INFO','PitchSmoother initialis√©');
    return true;
  }catch(err){ log('WARN','initSmoother: '+err.message); return false; }
}

/* ==================== ENREGISTREMENT ==================== */
function updateTimer(secs){ timerRec.textContent = fmtTime(secs); }

function startRecording(){
  try{
    if(!micStream){ log('WARN',"Active d'abord le micro"); return; }
    if(!detector) initDetector();
    if(!smoother) initSmoother();

    chunks=[]; lastBlob=null; recordedPitch=[]; recordDetectionCount=0; recordDetectionRawCount=0;
    recStart = audioCtx.currentTime;

    mediaRecorder = new MediaRecorder(micStream,{mimeType:'audio/webm;codecs=opus',audioBitsPerSecond:128000});
    mediaRecorder.ondataavailable = e=>{ if(e.data&&e.data.size>0) chunks.push(e.data); };
    mediaRecorder.onstop = ()=>{ if(chunks.length>0){ lastBlob = new Blob(chunks,{type:'audio/webm'}); log('INFO','Enregistrement termin√©'); } };

    mediaRecorder.start(100);
    btnRecStart.disabled=true; btnRecStop.disabled=false;

    timerInterval=setInterval(()=>{ updateTimer(audioCtx.currentTime - recStart); },100);
    log('INFO','Enregistrement d√©marr√©');
    startMonitor();
  }catch(err){ log('ERROR','startRecording: '+err.message); }
}
function stopRecording(){
  try{
    if(mediaRecorder && mediaRecorder.state==='recording'){
      mediaRecorder.stop();
      btnRecStart.disabled=false; btnRecStop.disabled=true;
      clearInterval(timerInterval); updateTimer(0);
      stopMonitor(); // la courbe reste affich√©e
    }
  }catch(err){ log('ERROR','stopRecording: '+err.message); }
}

/* ==================== DESSINS BACKGROUND ==================== */
function buildRecBackground(){
  const w=bgRec.width, h=bgRec.height, g=bgRecCtx;
  g.clearRect(0,0,w,h);

  // Bandes horizontales (‚Äì300 ‚Ä¶ +300 c)
  const bands = [
    {min:-300,max:-200,label:'tr√®s tr√®s grave'},
    {min:-200,max:-100,label:'tr√®s grave'},
    {min:-100,max:-50,label:'grave'},
    {min:-50,max:0,label:'moyen-grave'},
    {min:0,max:50,label:'milieu'},
    {max:100,min:50,label:'moyen-aigu'},
    {min:100,max:200,label:'aigu'},
    {min:200,max:300,label:'tr√®s aigu'}
  ];
  g.font='11px monospace'; g.textBaseline='middle';
  bands.forEach((b,i)=>{
    const y1 = mapCentsToY(b.max, h), y2 = mapCentsToY(b.min, h);
    g.fillStyle = i%2 ? 'rgba(59,130,246,0.05)' : 'rgba(167,139,250,0.05)';
    g.fillRect(LEFT_PAD, Math.min(y1,y2), w-LEFT_PAD-RIGHT_PAD, Math.abs(y2-y1));
    g.fillStyle='#94a3b8';
    g.fillText(b.label, 8, (y1+y2)/2);
  });

  // Grille horizontale principale (‚Äì200, ‚Äì100, 0, +100, +200)
  g.strokeStyle='#1a2642'; g.lineWidth=1;
  [-200,-100,0,100,200].forEach(c=>{
    const y = mapCentsToY(c,h);
    g.beginPath(); g.moveTo(LEFT_PAD, y); g.lineTo(w-RIGHT_PAD, y); g.stroke();
  });

  // Axe z√©ro (0 cent) ‚Äî pointill√© vert
  g.setLineDash([4,4]); g.strokeStyle='#10b981'; g.lineWidth=2;
  g.beginPath(); g.moveTo(LEFT_PAD, mapCentsToY(0,h)); g.lineTo(w-RIGHT_PAD, mapCentsToY(0,h)); g.stroke();
  g.setLineDash([]);

  // Ticks verticaux (toutes 5s) + labels pour fen√™tre de 30s
  g.strokeStyle='#22304f'; g.lineWidth=.5; g.fillStyle='#9ca3af'; g.textAlign='center'; g.textBaseline='alphabetic'; g.font='10px monospace';
  for(let s=0; s<=VISIBLE_WINDOW; s+=5){
    const x = LEFT_PAD + (w-LEFT_PAD-RIGHT_PAD)*(s/VISIBLE_WINDOW);
    g.beginPath(); g.moveTo(x, TOP_PAD); g.lineTo(x, h-BOTTOM_PAD); g.stroke();
    g.fillText(fmtTime(s), x, h-6);
  }

  // L√©gende ordonn√©e des cents en haut
  g.fillStyle='#9ca3af'; g.textAlign='right'; g.textBaseline='top'; g.font='11px monospace';
  g.fillText('+200c', LEFT_PAD-6, mapCentsToY(200,h)+2);
  g.fillText('+100c', LEFT_PAD-6, mapCentsToY(100,h)+2);
  g.fillText('0c', LEFT_PAD-6, mapCentsToY(0,h)+2);
  g.fillText('-100c', LEFT_PAD-6, mapCentsToY(-100,h)+2);
  g.fillText('-200c', LEFT_PAD-6, mapCentsToY(-200,h)+2);
}
function buildRefBackground(){
  const w=bgRef.width, h=bgRef.height, g=bgRefCtx;
  g.clearRect(0,0,w,h);
  // Grille simple + z√©ro
  g.strokeStyle='#1a2642'; g.lineWidth=1;
  [-200,-100,0,100,200].forEach(c=>{
    const y = mapCentsToY(c,h);
    g.beginPath(); g.moveTo(LEFT_PAD, y); g.lineTo(w-RIGHT_PAD, y); g.stroke();
  });
  g.setLineDash([4,4]); g.strokeStyle='#10b981'; g.lineWidth=2;
  g.beginPath(); g.moveTo(LEFT_PAD, mapCentsToY(0,h)); g.lineTo(w-RIGHT_PAD, mapCentsToY(0,h)); g.stroke();
  g.setLineDash([]);
}

/* ==================== RENDU (lisse) ==================== */
function drawCanvasRecBase(){ ctxRec.drawImage(bgRec, 0, 0); }
function drawCanvasRefBase(){ ctxRef.drawImage(bgRef, 0, 0); }

// Courbe liss√©e : quadratic midpoints (plus rond que lineTo)
function drawSmoothCurve(ctx, points, color){
  if(points.length<2) return;
  ctx.strokeStyle=color; ctx.lineWidth=3.5; ctx.lineJoin='round'; ctx.lineCap='round';
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for(let i=1;i<points.length-1;i++){
    const xc=(points[i].x+points[i+1].x)/2;
    const yc=(points[i].y+points[i+1].y)/2;
    ctx.quadraticCurveTo(points[i].x, points[i].y, xc, yc);
  }
  // dernier point
  ctx.lineTo(points[points.length-1].x, points[points.length-1].y);
  ctx.stroke();
}

function currentWindowRange(elapsed){
  const start = Math.max(0, elapsed - VISIBLE_WINDOW);
  const end = elapsed;
  return {start,end};
}

/* ==================== MONITOR TEMPS R√âEL ==================== */
function startMonitor(){
  try{
    if(!detector||!analyser) return;
    if(rafId) return;

    const buf=new Float32Array(analyser.fftSize);

    const tick=()=>{
      drawCanvasRecBase();

      // Fen√™tre glissante
      const elapsed = audioCtx.currentTime - recStart;
      const {start, end} = currentWindowRange(elapsed);
      const w = canvasRec.width, h = canvasRec.height;

      // Recalcule X des points visibles seulement (perf + pr√©cision)
      const vis = [];
      for(const p of recordedPitch){
        if(p.t>=start && p.t<=end){
          const x = LEFT_PAD + (w-LEFT_PAD-RIGHT_PAD)*((p.t-start)/VISIBLE_WINDOW);
          vis.push({x, y: mapCentsToY(p.cents, h)});
        }
      }

      if(vis.length>1){
        drawSmoothCurve(ctxRec, vis, '#3b82f6');
      }

      // D√©tection & ajout point
      try{
        analyser.getFloatTimeDomainData(buf);
        const hz = detector.detect(buf);

        if(hz && hz>=MIN_HZ && hz<=MAX_HZ){
          recordDetectionRawCount++;

          let smoothedHz = hz;
          if(smoother) smoothedHz = smoother.smooth(hz) ?? smoothedHz;

          if(smoothedHz && smoothedHz>0){
            const cents = hzToCents(smoothedHz, 440);
            recordedPitch.push({ t: elapsed, hz: smoothedHz, cents });
            recordDetectionCount++;
          }
        }
      }catch(err){ console.error('Pitch detection error:', err); }

      debugRec.textContent = `D√©tections brutes: ${recordDetectionRawCount} | Points liss√©s: ${recordDetectionCount}`;

      if(monitorOn || (mediaRecorder&&mediaRecorder.state==='recording')){ rafId = requestAnimationFrame(tick); }
    };

    tick();
  }catch(err){ log('ERROR','startMonitor: '+err.message); }
}
function stopMonitor(){ if(rafId){ cancelAnimationFrame(rafId); rafId=null; } drawCanvasRecBase(); }

/* ==================== EXPORTS ==================== */
function downloadBlob(blob,name){
  try{
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=name; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    log('INFO',`T√©l√©charg√©: ${name}`);
  }catch(err){ log('ERROR','downloadBlob: '+err.message); }
}
btnDownWebM.onclick=()=>{ if(!lastBlob) return log('WARN','Aucun enregistrement'); downloadBlob(lastBlob,'take.webm'); };
btnDownWAV.onclick=async()=>{ try{
  if(!lastBlob) return log('WARN','Aucun enregistrement');
  if(!window.WAVExport) return log('ERROR','WAVExport indisponible');
  const wav = await WAVExport.fromWebM(lastBlob); if(!wav) return log('ERROR','Conversion WAV √©chou√©e'); downloadBlob(wav,'take.wav');
}catch(err){ log('ERROR','WAV download: '+err.message);} };
btnDownMP3.onclick=async()=>{ try{
  if(!lastBlob) return log('WARN','Aucun enregistrement');
  if(!window.WAVExport) return log('ERROR','WAVExport indisponible');
  if(!window.MP3Export) return log('ERROR','MP3Export indisponible');
  const wav=await WAVExport.fromWebM(lastBlob); if(!wav) return log('ERROR','Conversion WAV √©chou√©e');
  log('INFO','Encodage MP3 en cours...'); const mp3=await MP3Export.fromWav(wav); if(!mp3) return log('ERROR','Conversion MP3 √©chou√©e'); downloadBlob(mp3,'take.mp3');
}catch(err){ log('ERROR','MP3 download: '+err.message);} };
btnClearRec.onclick=()=>{ try{
  chunks=[]; lastBlob=null; recordedPitch=[]; recordDetectionCount=0; recordDetectionRawCount=0; updateTimer(0);
  drawCanvasRecBase(); debugRec.textContent='D√©tections brutes: 0 | Points liss√©s: 0'; log('INFO','Enregistrement effac√©');
}catch(err){ log('ERROR','Clear rec: '+err.message);} };

/* ==================== FICHIERS LOCAUX ==================== */
fileUploadRec.addEventListener('change', async e=>{
  try{
    const file=e.target.files[0]; if(!file) return;
    await ensureAudio(); const buf=await file.arrayBuffer();
    lastBlob=new Blob([buf],{type:file.type}); chunks=[new Blob([buf],{type:file.type})];
    log('INFO',`Fichier charg√©: ${file.name}`);
  }catch(err){ log('ERROR','Upload rec: '+err.message); }
});
fileUploadRef.addEventListener('change', async e=>{
  try{
    const file=e.target.files[0]; if(!file) return;
    await ensureAudio(); const buf=await file.arrayBuffer(); const audio=await audioCtx.decodeAudioData(buf);
    const ch=audio.getChannelData(0); refData.duration=audio.duration; refDetectionCount=0;
    refData.pitch = extractPitch(ch, audio.sampleRate); drawReferenceData();
    log('INFO',`R√©f√©rence charg√©e: ${file.name} (${audio.duration.toFixed(1)}s, ${refData.pitch.length} points)`);
  }catch(err){ log('ERROR','Upload ref: '+err.message); }
});
btnClearRef.onclick=()=>{ try{ refData={pitch:[],duration:0}; refDetectionCount=0; drawCanvasRefBase(); debugRef.textContent='D√©tections brutes: 0 | Points liss√©s: 0'; log('INFO','R√©f√©rence effac√©e'); }catch(err){ log('ERROR','Clear ref: '+err.message);} };

/* ==================== EXTRACTION PITCH R√âF. ==================== */
function extractPitch(samples, sr){
  try{
    if(!detector) return [];
    const result=[]; const win=2048; const hop=512;
    if(smoother) smoother.reset();
    let detectionCount=0, rawCount=0;
    for(let i=0;i+win<=samples.length;i+=hop){
      const slice=samples.subarray(i,i+win);
      const hz = detector.detect(slice);
      if(hz && hz>=MIN_HZ && hz<=MAX_HZ){
        rawCount++;
        let smoothedHz = hz; if(smoother) smoothedHz = smoother.smooth(hz) ?? smoothedHz;
        if(smoothedHz && smoothedHz>0){
          detectionCount++;
          const t = i/sr; const cents = hzToCents(smoothedHz, 440);
          result.push({t, hz:smoothedHz, cents});
        }
      }
    }
    refDetectionCount=detectionCount;
    log('INFO',`Extraction r√©f√©rence: ${rawCount} brutes ‚Üí ${detectionCount} liss√©es`);
    return result;
  }catch(err){ log('ERROR','extractPitch: '+err.message); return []; }
}

/* ==================== DESSIN R√âF. ==================== */
function drawReferenceData(){
  try{
    drawCanvasRefBase();
    if(refData.pitch.length===0){ debugRef.textContent='D√©tections brutes: 0 | Points liss√©s: 0'; return; }
    const w=canvasRef.width, h=canvasRef.height, dur=Math.max(refData.duration,1);
    const pts = refData.pitch.map(p=>({
      x: LEFT_PAD + (w-LEFT_PAD-RIGHT_PAD)*(p.t/dur),
      y: mapCentsToY(p.cents,h)
    }));
    drawSmoothCurve(ctxRef, pts, '#a78bfa');

    debugRef.textContent = `D√©tections brutes: ? | Points liss√©s: ${refData.pitch.length}`;

    const devs = refData.pitch.map(p=>Math.abs(p.cents));
    const avg = devs.reduce((a,b)=>a+b,0)/devs.length;
    const max = Math.max(...devs);
    const inTune = refData.pitch.filter(p=>Math.abs(p.cents)<25).length/refData.pitch.length*100;
    mAvg.textContent = avg.toFixed(1)+'c';
    mMax.textContent = max.toFixed(1)+'c';
    mInTune.textContent = inTune.toFixed(1)+'%';
  }catch(err){ log('ERROR','drawReferenceData: '+err.message); }
}

/* ==================== √âV√âNEMENTS ==================== */
btnMic.onclick=()=>activateMic();
btnRecStart.onclick=()=>startRecording();
btnRecStop.onclick=()=>stopRecording();
btnMonOff.onclick=()=>{ monitorOn=false; btnMonOff.classList.add('active'); btnMonOn.classList.remove('active'); stopMonitor(); log('INFO','Moniteur OFF'); };
btnMonOn.onclick =()=>{ monitorOn=true;  btnMonOn.classList.add('active'); btnMonOff.classList.remove('active'); if(audioCtx) startMonitor(); log('INFO','Moniteur ON'); };

/* ==================== INIT ==================== */
syncBackbuffers();
drawCanvasRecBase();
drawCanvasRefBase();
window.addEventListener('resize', ()=>{ syncBackbuffers(); drawCanvasRecBase(); drawCanvasRefBase(); });

log('INFO','Interface pr√™te ‚Äî Live 30s, ¬±200c, ticks 5s / courbe liss√©e');
</script>
</body>
</html>
