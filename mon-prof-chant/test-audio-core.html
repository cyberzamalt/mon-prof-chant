<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Test Audio Core ‚Äì Pitch & Timeline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#9ca3af;
      --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --blue:#60a5fa; --line:#111827;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
    h1{font-size:20px;margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .btn{border:0;border-radius:8px;padding:9px 12px;font-weight:700;background:#1f2937;color:#e5e7eb;cursor:pointer}
    .btn[disabled]{opacity:.4;cursor:not-allowed}
    .btn.ok{background:#16a34a;color:#fff}
    .btn.stop{background:#ef4444;color:#fff}
    .btn.warn{background:#f59e0b;color:#111}
    .card{background:var(--card);border-radius:12px;padding:12px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.18)}
    .badge{display:inline-block;background:#0e7490;color:#cffafe;border:1px solid #155e75;padding:4px 8px;border-radius:8px;font-weight:700}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kv{background:#0b1324;border:1px solid #1f2a44;border-radius:10px;padding:10px}
    .kv b{display:block;color:#93c5fd;margin-bottom:4px}
    .log{background:#020617;color:#bfdbfe;border-radius:10px;padding:10px;white-space:pre-wrap;max-height:200px;overflow:auto}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
    .seg{display:inline-flex;gap:6px;align-items:center;background:#0b1324;border:1px solid #1f2a44;padding:5px;border-radius:10px}
    .seg button{background:#0b1324;border:1px solid #1f2a44;color:#cbd5e1;padding:6px 10px;border-radius:8px;cursor:pointer}
    .seg button.active{background:#1f2937;color:#fff;border-color:#334155}
    .plot{position:relative;height:280px}
    canvas{display:block;width:100%;height:280px;border-radius:10px}
    .axis{position:absolute;inset:0;z-index:1}
    .pitch{position:absolute;inset:0;z-index:2;pointer-events:none}
    .footbar{display:flex;gap:8px;align-items:center;justify-content:flex-start;margin-top:8px}
    .hint{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üé§ Test Audio Core ‚Äî Pitch (cents/notes) + Timeline (ligne m√©diane)</h1>

    <div class="row">
      <button class="btn ok" id="btnInit">Activer micro</button>
      <div class="seg">
        <label style="padding:0 6px;">üéß Moniteur live</label>
        <button class="btn" id="btnLiveOff">OFF</button>
        <button class="btn" id="btnLiveOn">ON</button>
      </div>
      <button class="btn" id="btnStart" disabled>‚ñ∂Ô∏è D√©marrer l‚Äôenregistrement</button>
      <button class="btn stop" id="btnStop" disabled>‚ñ† Stop</button>
      <div class="seg">
        <button class="btn active" id="z1">x1</button>
        <button class="btn" id="z2">x2</button>
        <button class="btn" id="z4">x4</button>
      </div>
      <div class="seg">
        <button class="btn" id="mCents">Cents (justesse)</button>
        <button class="btn active" id="mNotes">Absolu (notes)</button>
      </div>
      <span class="badge" id="badgeTime">00:00</span>
    </div>

    <div class="card">
      <div class="toolbar hint">Pitch ‚Äî <span id="lblRef">ligne m√©diane = note de r√©f√©rence</span></div>
      <div class="plot">
        <canvas id="axis" class="axis"></canvas>
        <canvas id="pitch" class="pitch"></canvas>
      </div>
      <div class="footbar">
        <button class="btn" id="dlWebm" disabled>‚¨áÔ∏è T√©l√©charger WebM</button>
        <button class="btn" id="dlWav" disabled>‚¨áÔ∏è Exporter en WAV</button>
        <button class="btn" id="dlMp3" disabled>‚¨áÔ∏è Exporter en MP3</button>
        <span class="hint">Astuce : la courbe ne s‚Äôaffiche qu‚Äôen <b>Moniteur live ON</b> ou pendant l‚Äôenregistrement.</span>
      </div>
    </div>

    <div class="card">
      <b>Console</b>
      <div class="log" id="log">Syst√®me de logs pr√™t‚Ä¶</div>
    </div>
  </div>

  <script type="module">
    import { Logger } from './src/logging/Logger.js';
    import AudioEngine from './src/audio/core/AudioEngine.js';
    import MicrophoneManager from './src/audio/core/MicrophoneManager.js';
    import TimelineRenderer from './src/plot/TimelineRenderer.js';
    import PitchService from './src/audio/analysis/PitchService.js';
    import RecorderService from './src/audio/recorder/RecorderService.js';
    import ExportService from './src/audio/export/ExportService.js';
    import { CONFIG } from './src/config.js';

    const logEl = document.getElementById('log');
    const btnInit = document.getElementById('btnInit');
    const btnLiveOn = document.getElementById('btnLiveOn');
    const btnLiveOff = document.getElementById('btnLiveOff');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const z1 = document.getElementById('z1'), z2 = document.getElementById('z2'), z4 = document.getElementById('z4');
    const mCents = document.getElementById('mCents'), mNotes = document.getElementById('mNotes');
    const badgeTime = document.getElementById('badgeTime');
    const lblRef = document.getElementById('lblRef');

    const axis = document.getElementById('axis');
    const pitch = document.getElementById('pitch');

    const addLog = (s) => { logEl.textContent += '\n' + s; logEl.scrollTop = logEl.scrollHeight; };
    Logger.setExternalSink?.((level, scope, msg, data) => {
      addLog(`[${level}] [${scope}] ${msg}${data? ' | ' + JSON.stringify(data): ''}`);
    });

    // Core services
    const engine = AudioEngine.getInstance?.({ sampleRate: CONFIG?.audio?.sampleRate || 48000, latencyHint:'interactive' }) || new AudioEngine();
    let mic = null;
    let micStream = null;
    let srcNode = null;

    const timeline = new TimelineRenderer({ axisCanvas: axis, pitchCanvas: pitch });
    timeline.setMode('abs'); // par d√©faut: ABSOLU (notes)
    timeline.setZoom(1); // x1

    const pitchSvc = new PitchService();
    pitchSvc.setMode('abs');
    pitchSvc.enableSmoothing({ gapMaxMs: 120 });

    const rec = new RecorderService();
    const exporter = new ExportService();

    let liveOn = false;
    let recording = false;
    let t0 = 0;
    let recBlob = null;

    function resize() { timeline.resize(); }
    window.addEventListener('resize', resize);

    // UI initial state
    btnLiveOff.classList.add('active');
    mNotes.classList.add('active'); mCents.classList.remove('active');
    z1.classList.add('active'); z2.classList.remove('active'); z4.classList.remove('active');

    function setLive(on) {
      liveOn = !!on;
      btnLiveOn.classList.toggle('active', liveOn);
      btnLiveOff.classList.toggle('active', !liveOn);

      if (liveOn) {
        if (srcNode) {
          pitchSvc.start({ sourceNode: srcNode, sampleRate: srcNode.context.sampleRate, mode: 'live' });
          addLog('[INFO] Live ON (moniteur)');
        }
      } else {
        pitchSvc.stop();
        timeline.setCursor(null);
        addLog('[INFO] Live OFF');
      }
      timeline.draw();
    }

    function uiRecording(on) {
      recording = !!on;
      btnStart.disabled = on || !micStream;
      btnStop.disabled = !on;
      document.getElementById('dlWebm').disabled = on || !recBlob;
      document.getElementById('dlWav').disabled = on || !recBlob;
      document.getElementById('dlMp3').disabled = on || !recBlob;
    }

    // Wire pitch events -> renderer
    pitchSvc.on('pitch', ({ t, midi, cents }) => {
      if (!liveOn && !recording) return; // s√©curit√©
      if (recording) {
        const cursorT = (performance.now() - t0) / 1000;
        timeline.setCursor(cursorT);
      } else if (liveOn) {
        // curseur live = AudioContext time diff
        timeline.setCursor(engine.getContext()?.currentTime ?? t);
      }
      timeline.appendPoint({ t: (recording ? (performance.now()-t0)/1000 : (engine.getContext()?.currentTime ?? t)), midi, cents });
      timeline.draw();
    });
    pitchSvc.on('reference', ({ midiRef, noteLabel }) => {
      timeline.setReference(midiRef, noteLabel);
      lblRef.textContent = `R√©f√©rence: ${noteLabel}`;
      timeline.draw();
    });

    // Recorder events
    rec.on('tick', ({ sec }) => { badgeTime.textContent = new Date(sec*1000).toISOString().substr(14,5); });
    rec.on('stop', ({ blob }) => {
      recBlob = blob;
      uiRecording(false);
      timeline.setCursor(null);
      addLog('[INFO] Enregistrement termin√©');
    });

    // Buttons
    btnInit.addEventListener('click', async () => {
      try {
        await engine.initialize?.();
        mic = new MicrophoneManager(engine);
        const ok = await mic.requestAccess();
        if (!ok) { addLog('[ERROR] Acc√®s micro refus√©'); return; }
        micStream = mic.getStream();
        const ctx = engine.getContext();
        srcNode = ctx.createMediaStreamSource(micStream);

        // reset UI
        btnStart.disabled = false;
        addLog('[INFO] Micro OK (permission accord√©e)');
      } catch (e) {
        addLog('[ERROR] Init: ' + (e?.message || e));
      }
    });

    btnLiveOn.addEventListener('click', () => setLive(true));
    btnLiveOff.addEventListener('click', () => setLive(false));

    btnStart.addEventListener('click', async () => {
      if (!micStream) { addLog('[WARN] Activer micro d‚Äôabord'); return; }
      // reset timeline & start cursor at 0
      timeline.clear();
      timeline.setAutoFollow(true);
      t0 = performance.now();

      // start pitch (record mode)
      pitchSvc.resetReference();
      pitchSvc.start({ sourceNode: srcNode, sampleRate: srcNode.context.sampleRate, mode: 'record' });

      // start recorder
      recBlob = null;
      rec.start({ stream: micStream });
      uiRecording(true);
      addLog('[INFO] Enregistrement d√©marr√©');
    });

    btnStop.addEventListener('click', () => {
      if (!rec.isRecording()) return;
      rec.stop();
      pitchSvc.stop();
      timeline.setAutoFollow(false); // fige la vue
      addLog('[INFO] Arr√™t demand√©');
    });

    // zoom
    function setZoom(x) {
      z1.classList.toggle('active', x===1);
      z2.classList.toggle('active', x===2);
      z4.classList.toggle('active', x===4);
      timeline.setZoom(x);
      timeline.draw();
    }
    z1.addEventListener('click', () => setZoom(1));
    z2.addEventListener('click', () => setZoom(2));
    z4.addEventListener('click', () => setZoom(4));

    // mode
    function setMode(mode) {
      mCents.classList.toggle('active', mode==='cents');
      mNotes.classList.toggle('active', mode==='abs');
      pitchSvc.setMode(mode);
      timeline.setMode(mode);
      timeline.draw();
    }
    mCents.addEventListener('click', () => setMode('cents'));
    mNotes.addEventListener('click', () => setMode('abs'));

    // exports
    const dlWebm = document.getElementById('dlWebm');
    const dlWav  = document.getElementById('dlWav');
    const dlMp3  = document.getElementById('dlMp3');

    dlWebm.addEventListener('click', () => {
      if (!recBlob) return;
      exporter.save(recBlob, `prise-${Date.now()}.webm`);
    });
    dlWav.addEventListener('click', async () => {
      if (!recBlob) return;
      const wav = await exporter.toWav(recBlob);
      exporter.save(wav, `prise-${Date.now()}.wav`);
    });
    dlMp3.addEventListener('click', async () => {
      if (!recBlob) return;
      const wav = await exporter.toWav(recBlob);
      const mp3 = await exporter.toMp3(wav, { bitrate: 128 });
      exporter.save(mp3, `prise-${Date.now()}.mp3`);
    });

    // init plot sizes
    resize();
  </script>
</body>
</html>
