<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mon Professeur de Chant ‚Äì v2 clean</title>
  <style>
    :root{
      --bg:#0c1420; --panel:#111a28; --grid:#1a2642; --text:#e5e7eb;
      --muted:#9ca3af; --ok:#10b981; --err:#ef4444; --accent:#22c55e;
      --border:#22304e; --axis:#2a3b63;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Arial,sans-serif}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .topbar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .btn{border:1px solid var(--border);background:#152036;color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.ok{background:var(--accent);color:#04110a;border-color:#0b3}
    .btn.danger{background:#b91c1c;border-color:#7f1d1d}
    .btn.secondary{background:#1b2744}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px}
    .card h3{margin:0 0 10px 0;font-size:15px;color:#9cc1ff}
    .status{font-size:12px;color:var(--muted)}
    canvas{width:100%;height:320px;background:#0a1224;border:1px solid var(--border);border-radius:8px;display:block}
    .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
    .metric{background:#0e1a33;border:1px solid var(--border);border-radius:8px;padding:8px;text-align:center}
    .metric b{display:block;font-size:18px}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px 0}
    .hidden{display:none!important}
    .note{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <button id="btnStart" class="btn ok">‚ñ∂Ô∏è D√©marrer</button>
      <button id="btnStop" class="btn danger" disabled>‚èπÔ∏è Arr√™ter</button>
      <button id="btnRec" class="btn secondary" disabled>‚è∫Ô∏è Enregistrer</button>
      <button id="btnClear" class="btn">üóëÔ∏è Effacer</button>
      <span id="appStatus" class="status">Pr√™t.</span>
    </div>

    <div class="row">
      <div class="card">
        <div class="toolbar">
          <h3>Enregistrement Live</h3>
          <a id="dlLive" class="btn secondary hidden" download="live.mp3">üíæ T√©l√©charger MP3</a>
        </div>
        <canvas id="canvas-recording" width="520" height="320"></canvas>
        <div class="metrics">
          <div class="metric"><span>FR√âQUENCE</span><b id="mFreq">‚Äî</b></div>
          <div class="metric"><span>NOTE</span><b id="mNote">‚Äî</b></div>
          <div class="metric"><span>CENTS</span><b id="mCents">‚Äî</b></div>
        </div>
      </div>

      <div class="card">
        <div class="toolbar">
          <h3>R√©f√©rence Audio</h3>
          <a id="dlRef" class="btn secondary hidden" download="reference.mp3">üíæ T√©l√©charger MP3</a>
        </div>
        <canvas id="canvas-reference" width="520" height="320"></canvas>
        <p class="note">√Ä venir : chargement d‚Äôun MP3/Youtube pour comparer visuellement.</p>
      </div>
    </div>
  </div>

  <!-- Librairies ‚Äúnon modules‚Äù -->
  <script src="src/vendor/yin-detector.js"></script>
  <script src="src/utils/pitch-smoothing.js"></script>
  <script src="src/vendor/lame.min.js"></script>

  <!-- App (modules) -->
  <script type="module">
    import app from './src/app.js';

    const $ = (id) => document.getElementById(id);
    const btnStart = $('btnStart'), btnStop = $('btnStop'), btnRec = $('btnRec'), btnClear = $('btnClear');
    const status = $('appStatus');
    const dlLive = $('dlLive');
    const liveCanvas = $('canvas-recording');
    const refCanvas  = $('canvas-reference');

    // Handlers visibles globalement ‚Äì pas de jQuery, pas de .ready()
    btnStart.onclick = async () => {
      try {
        status.textContent = 'D√©marrage...';
        await app.start();                 // init context + micro
        app.getPanel('recording')?.start(liveCanvas);
        app.getPanel('reference')?.start(refCanvas);
        btnStart.disabled = true; btnStop.disabled = false; btnRec.disabled = false;
        status.textContent = 'Micro actif.';
      } catch (e) {
        console.error(e);
        status.textContent = 'Erreur de d√©marrage.';
        alert('Erreur: ' + (e?.message || e));
      }
    };

    btnStop.onclick = () => {
      try {
        app.stop();
        btnStart.disabled = false; btnStop.disabled = true; btnRec.disabled = true;
        status.textContent = 'Arr√™t√©.';
      } catch (e) {
        console.error(e);
        alert('Erreur: ' + (e?.message || e));
      }
    };

    btnRec.onclick = async () => {
      try {
        if (app.getService('recording')?.isRecording()) {
          const data = await app.getService('recording').stop();
          status.textContent = `Enregistrement arr√™t√© (${(data?.duration/1000).toFixed(2)}s)`;
          if (data?.mp3Blob) {
            dlLive.classList.remove('hidden');
            dlLive.href = URL.createObjectURL(data.mp3Blob);
          }
          btnRec.textContent = '‚è∫Ô∏è Enregistrer';
        } else {
          await app.getService('recording').start();
          status.textContent = 'Enregistrement en cours...';
          btnRec.textContent = '‚èπÔ∏è Arr√™ter Enreg.';
        }
      } catch (e) {
        console.error(e);
        alert('Erreur: ' + (e?.message || e));
      }
    };

    btnClear.onclick = () => {
      app.getPanel('recording')?.clear();
      app.getPanel('reference')?.clear();
      status.textContent = 'Effac√©.';
    };

    // Au chargement du DOM, on initialise l‚Äôapp (sans lancer le micro)
    document.addEventListener('DOMContentLoaded', async () => {
      try { await app.init(); } catch(e){ console.error(e); }
    });
  </script>
</body>
</html>
