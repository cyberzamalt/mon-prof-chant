<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mon Professeur de Chant ‚Äì v2 Pitch Detection</title>
  <style>
    :root{
      --bg:#0c1420; --panel:#111a28; --grid:#1a2642; --text:#e5e7eb;
      --muted:#9ca3af; --ok:#10b981; --err:#ef4444; --accent:#22c55e;
      --border:#22304e; --axis:#2a3b63;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Arial,sans-serif}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .topbar{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:#152036;color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.ok{background:var(--accent);color:#04110a;border-color:#0b3}
    .btn.danger{background:#b91c1c;border-color:#7f1d1d}
    .btn.secondary{background:#1b2744}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px}
    .card h3{margin:0 0 10px 0;font-size:15px;color:#9cc1ff}
    .status{font-size:12px;color:var(--muted)}
    canvas{width:100%;height:320px;background:#0a1224;border:1px solid var(--border);border-radius:8px;display:block}
    .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
    .metric{background:#0e1a33;border:1px solid var(--border);border-radius:8px;padding:8px;text-align:center}
    .metric span{display:block;font-size:11px;color:var(--muted);margin-bottom:4px}
    .metric b{display:block;font-size:18px;color:var(--text)}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px 0}
    .hidden{display:none!important}
    .note{color:var(--muted);font-size:12px;margin-top:8px}
    .info{background:#1e3a5f;border:1px solid #2563eb;color:#93c5fd;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px}
    .info strong{color:#60a5fa}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="info">
      <strong>üé§ Mon Professeur de Chant v2</strong><br>
      D√©tection pitch temps r√©el avec algorithme YIN + visualisation sinuso√Ødale
    </div>

    <div class="topbar">
      <button id="btnStart" class="btn ok">‚ñ∂Ô∏è D√©marrer</button>
      <button id="btnStop" class="btn danger" disabled>‚èπÔ∏è Arr√™ter</button>
      <button id="btnRec" class="btn secondary" disabled>‚è∫Ô∏è Enregistrer</button>
      <button id="btnClear" class="btn">üóëÔ∏è Effacer</button>
      <span id="appStatus" class="status">Pr√™t. Cliquez "D√©marrer" pour activer le micro.</span>
    </div>

    <div class="row">
      <div class="card">
        <div class="toolbar">
          <h3>üéµ Enregistrement Live</h3>
          <a id="dlLive" class="btn secondary hidden" download="live.mp3">üíæ T√©l√©charger MP3</a>
        </div>
        <canvas id="canvas-recording" width="520" height="320"></canvas>
        <div class="metrics">
          <div class="metric">
            <span>FR√âQUENCE</span>
            <b id="mFreq">‚Äî</b>
          </div>
          <div class="metric">
            <span>NOTE</span>
            <b id="mNote">‚Äî</b>
          </div>
          <div class="metric">
            <span>CENTS</span>
            <b id="mCents">‚Äî</b>
          </div>
        </div>
        <p class="note">
          Chantez ou jouez une note - la courbe monte/descend selon la hauteur.
          La ligne centrale = La (440 Hz).
        </p>
      </div>

      <div class="card">
        <div class="toolbar">
          <h3>üìä R√©f√©rence Audio</h3>
          <a id="dlRef" class="btn secondary hidden" download="reference.mp3">üíæ T√©l√©charger MP3</a>
        </div>
        <canvas id="canvas-reference" width="520" height="320"></canvas>
        <p class="note">
          <strong>√Ä venir :</strong> Import MP3/YouTube pour comparaison visuelle avec votre performance.
        </p>
      </div>
    </div>
  </div>

  <!-- Librairies "non modules" - charg√©es via <script> -->
  <script src="src/vendor/yin-detector.js"></script>
  <script src="src/vendor/lame.min.js"></script>

  <!-- App (modules ES6) -->
  <script type="module">
    import app from './src/app.js';

    // Helpers DOM
    const $ = (id) => document.getElementById(id);
    
    // √âl√©ments UI
    const btnStart = $('btnStart');
    const btnStop = $('btnStop');
    const btnRec = $('btnRec');
    const btnClear = $('btnClear');
    const status = $('appStatus');
    const dlLive = $('dlLive');
    const liveCanvas = $('canvas-recording');
    const refCanvas = $('canvas-reference');

    // √âtat local
    let recording = false;

    // Handler : D√©marrer (micro + visualisation)
    btnStart.onclick = async () => {
      try {
        status.textContent = '‚è≥ D√©marrage du micro...';
        btnStart.disabled = true;

        // 1. D√©marrer l'app (init AudioContext + micro)
        await app.start();

        // 2. D√©marrer les panneaux de visualisation
        const panelLive = app.getPanel('recording');
        const panelRef = app.getPanel('reference');

        if (panelLive) {
          panelLive.start(liveCanvas);
        }

        if (panelRef) {
          panelRef.start(refCanvas);
        }

        // 3. Mettre √† jour UI
        btnStop.disabled = false;
        btnRec.disabled = false;
        status.textContent = '‚úÖ Micro actif - Visualisation en cours';

      } catch (e) {
        console.error('[UI] Erreur d√©marrage', e);
        status.textContent = '‚ùå Erreur de d√©marrage';
        alert('Erreur: ' + (e?.message || e));
        btnStart.disabled = false;
      }
    };

    // Handler : Arr√™ter (stop micro + visualisation)
    btnStop.onclick = () => {
      try {
        app.stop();
        
        btnStart.disabled = false;
        btnStop.disabled = true;
        btnRec.disabled = true;
        
        status.textContent = '‚è∏Ô∏è Arr√™t√©';
        
      } catch (e) {
        console.error('[UI] Erreur arr√™t', e);
        alert('Erreur: ' + (e?.message || e));
      }
    };

    // Handler : Enregistrer (toggle)
    btnRec.onclick = async () => {
      try {
        const recService = app.getService('recording');
        
        if (!recService) {
          throw new Error('Service d\'enregistrement non disponible');
        }

        if (recService.isRecording()) {
          // Arr√™ter l'enregistrement
          status.textContent = '‚è≥ Encodage MP3...';
          btnRec.disabled = true;

          const data = await recService.stop();
          
          if (data && data.mp3Blob) {
            // Afficher bouton de t√©l√©chargement
            dlLive.classList.remove('hidden');
            dlLive.href = URL.createObjectURL(data.mp3Blob);
            dlLive.download = data.name || 'enregistrement.mp3';
            
            status.textContent = `‚úÖ Enregistrement termin√© (${(data.duration/1000).toFixed(1)}s)`;
          } else {
            status.textContent = '‚úÖ Enregistrement termin√©';
          }

          btnRec.textContent = '‚è∫Ô∏è Enregistrer';
          btnRec.disabled = false;
          recording = false;

        } else {
          // D√©marrer l'enregistrement
          await recService.start();
          
          status.textContent = 'üî¥ Enregistrement en cours...';
          btnRec.textContent = '‚èπÔ∏è Arr√™ter Enreg.';
          recording = true;
        }

      } catch (e) {
        console.error('[UI] Erreur enregistrement', e);
        alert('Erreur: ' + (e?.message || e));
        btnRec.disabled = false;
      }
    };

    // Handler : Effacer
    btnClear.onclick = () => {
      try {
        const panelLive = app.getPanel('recording');
        const panelRef = app.getPanel('reference');
        
        if (panelLive) panelLive.clear();
        if (panelRef) panelRef.clear();
        
        // Reset m√©triques
        $('mFreq').textContent = '‚Äî';
        $('mNote').textContent = '‚Äî';
        $('mCents').textContent = '‚Äî';
        $('mCents').style.color = '';
        
        // Cacher bouton download
        dlLive.classList.add('hidden');
        
        status.textContent = 'üóëÔ∏è Canvas effac√©';
        
      } catch (e) {
        console.error('[UI] Erreur effacement', e);
      }
    };

    // Initialiser l'app au chargement du DOM
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await app.init();
        console.log('[UI] Application initialis√©e');
      } catch (e) {
        console.error('[UI] Erreur initialisation', e);
      }
    });
  </script>
</body>
</html>
